# Check what variables the model actually needs
model_vars <- names(pos_model$var.summary)
# Create a clean subset of prediction data with only required variables
prediction_subset <- startlist_prepared
# Ensure all required variables exist
for(var in model_vars) {
if(!(var %in% names(prediction_subset))) {
log_warn(paste("Missing required variable:", var, "- adding with default values"))
prediction_subset[[var]] <- 0
} else {
# Handle NAs
if(any(is.na(prediction_subset[[var]]))) {
if(is.numeric(prediction_subset[[var]])) {
prediction_subset[[var]] <- replace_na_with_quartile(prediction_subset[[var]])
}
}
}
}
# Make predictions
base_predictions <- mgcv::predict.gam(pos_model, newdata = prediction_subset, type = "response")
# Store predictions
position_preds[[paste0(prob_col, "_base")]] <- base_predictions
# Apply adjustments if available
if(adj_name %in% names(position_adjustments)) {
# Get adjustments
pos_adj <- position_adjustments[[adj_name]]
# Join with predictions
position_preds <- position_preds %>%
left_join(pos_adj, by = "Skier") %>%
mutate(
# Replace NAs with zeros
altitude_effect = replace_na(altitude_effect, 0),
period_effect = replace_na(period_effect, 0),
ms_effect = replace_na(ms_effect, 0),
# Apply adjustments
altitude_adjustment = altitude_effect,
period_adjustment = period_effect,
ms_adjustment = ms_effect,
# Calculate adjusted probabilities
adjusted_prob = get(paste0(prob_col, "_base")) +
altitude_adjustment + period_adjustment + ms_adjustment,
# Ensure probabilities are between 0 and 1
adjusted_prob = pmin(pmax(adjusted_prob, 0), 1)
)
# Use adjusted probability as final
position_preds[[prob_col]] <- position_preds$adjusted_prob
# Clean up temporary columns
position_preds <- position_preds %>%
dplyr::select(-altitude_effect, -period_effect, -ms_effect,
-altitude_adjustment, -period_adjustment, -ms_adjustment, -adjusted_prob)
} else {
# Use base prediction if no adjustments
position_preds[[prob_col]] <- position_preds[[paste0(prob_col, "_base")]]
}
# Clean up base prediction column
position_preds <- position_preds %>%
dplyr::select(-paste0(prob_col, "_base"))
# Convert to percentage and round
position_preds[[prob_col]] <- round(position_preds[[prob_col]] * 100, 1)
log_info(paste("Made predictions with adjustments for position threshold", threshold))
}, error = function(e) {
log_warn(paste("Complete failure for threshold", threshold, ":", e$message))
# Set a reasonable default based on threshold
position_preds[[prob_col]] <- rep(threshold, nrow(position_preds))
})
} else {
log_warn(paste("No model found for threshold", threshold))
position_preds[[prob_col]] <- NA
}
}
# Normalize position probabilities to ensure they sum to the correct totals
position_preds <- normalize_position_probabilities(position_preds, position_thresholds)
# Store position predictions for this race
position_predictions[[i]] <- position_preds
# Prepare startlist points predictions (original functionality)
race_dfs[[i]] <- startlist_prepared %>%
mutate(
Base_Prediction = predict(model, newdata = .),
) %>%
left_join(skier_adjustments, by = "Skier") %>%
mutate(
# Regular adjustments
altitude_effect = replace_na(altitude_effect, 0),
period_effect = replace_na(period_effect, 0),
ms_effect = replace_na(ms_effect, 0),
# Volatility metrics
prediction_volatility = replace_na(prediction_volatility, 0),
consistency_score = replace_na(consistency_score, 0),
upside_potential = replace_na(upside_potential, 0),
downside_risk = replace_na(downside_risk, 0),
volatility_ratio = replace_na(volatility_ratio, 1),
n_recent_races = replace_na(n_recent_races, 0),
# Adjustments
altitude_adjustment = altitude_effect,
period_adjustment = period_effect,
ms_adjustment = ms_effect,
# Base prediction and adjustments - no race probability needed for race day
Predicted_Points = Base_Prediction + altitude_adjustment +
period_adjustment + ms_adjustment,
Predicted_Points = pmax(pmin(Predicted_Points, 100), 0),
Final_Prediction = Predicted_Points,
# Different scoring scenarios
confidence_factor = pmin(n_recent_races / 10, 1),
scaled_upside_potential = upside_potential * (Predicted_Points/100),
scaled_downside_potential = downside_risk * (Predicted_Points/100),
# Safe prediction (downside)
Safe_Prediction = pmax(
Predicted_Points - (prediction_volatility * 1.5 * confidence_factor),
0
),
Safe_Prediction = pmax(
Predicted_Points - (abs(scaled_downside_potential) * volatility_ratio * confidence_factor),
0
),
# Upside prediction
Upside_Prediction = pmin(
Predicted_Points + (prediction_volatility * 1.5 * confidence_factor),
100
),
Upside_Prediction = pmin(
Predicted_Points + (scaled_upside_potential * volatility_ratio * confidence_factor),
100
)
) %>%
dplyr::select(Skier, Nation,
Base_Prediction, altitude_adjustment,
period_adjustment, ms_adjustment,
prediction_volatility, volatility_ratio, confidence_factor,
Final_Prediction, Safe_Prediction, Upside_Prediction)
# Apply pursuit handling if needed
if(races$Pursuit[i] == 1) {
# Get startlist points
startlist_points <- startlist %>%
mutate(
# Use the appropriate points system based on the Stage flag
startlist_points = case_when(
row_number() <= length(if(is_stage_race) stage_points else wc_points) ~
(if(is_stage_race) stage_points else wc_points)[row_number()],
TRUE ~ 0
)
) %>%
dplyr::select(Skier, startlist_points)
# Apply pursuit logic - average predicted points with startlist points
race_dfs[[i]] <- race_dfs[[i]] %>%
left_join(startlist_points, by = "Skier") %>%
mutate(
startlist_points = replace_na(startlist_points, 0),
# Weighted average of predicted points and startlist points
Final_Prediction = (Predicted_Points + startlist_points) / 2,
Safe_Prediction = (Safe_Prediction + startlist_points) / 2,
Upside_Prediction = (Upside_Prediction + startlist_points) / 2
) %>%
dplyr::select(-startlist_points)
log_info(paste("Applied pursuit logic to race", i))
}
}
# Get number of races from races dataframe
n_races <- nrow(races)
# Combine all race predictions
final_predictions <- combine_predictions(race_dfs, startlist)
log_info(paste("Final predictions calculated for", gender))
# Create post predictions for blog
post_predictions <- create_post_predictions(final_predictions, n_races, gender)
# NEW: Combine all position predictions into one dataframe
all_position_predictions <- bind_rows(position_predictions)
# NEW: Create formatted position probabilities
formatted_position_results <- format_position_results(all_position_predictions, current_date, gender, races)
# Create folder path based on today's date
today_folder <- format(current_date, "%Y%m%d")
dir_path <- paste0("~/blog/daehl-e/content/post/cross-country/drafts/race-picks/", today_folder)
# Create directory if it doesn't exist
if (!dir.exists(dir_path)) {
dir.create(dir_path, recursive = TRUE)
}
# Save predictions to Excel
file_path <- file.path(dir_path, paste0(ifelse(gender == "men", "men", "ladies"), ".xlsx"))
write.xlsx(post_predictions, file = file_path)
log_info(paste("Saved", gender, "race day predictions to", file_path))
# Return both points and position predictions
return(list(
full_predictions = final_predictions,
post_predictions = post_predictions,
position_predictions = all_position_predictions,
formatted_position_results = formatted_position_results
))
}
# Function to create top contenders summary
create_top_contenders_summary <- function(men_results, ladies_results) {
today_folder <- format(current_date, "%Y%m%d")
dir_path <- paste0("~/blog/daehl-e/content/post/cross-country/drafts/race-picks/", today_folder)
if (!dir.exists(dir_path)) {
dir.create(dir_path, recursive = TRUE)
}
top_contenders <- list()
# Process men's results if available
if(!is.null(men_results) && !is.null(men_results$position_predictions)) {
men_positions <- men_results$position_predictions
men_races <- unique(men_positions$Race)
for(race_num in men_races) {
race_df <- men_positions %>%
filter(Race == race_num)
# Top 5 for win probability
win_contenders <- race_df %>%
arrange(desc(prob_top1)) %>%
head(5) %>%
dplyr::select(Skier, Nation, prob_top1) %>%
rename(`Win%` = prob_top1)
top_contenders[[paste0("Men Race ", race_num, " - Win")]] <- win_contenders
# Top 5 for podium probability
podium_contenders <- race_df %>%
arrange(desc(prob_top3)) %>%
head(5) %>%
dplyr::select(Skier, Nation, prob_top3) %>%
rename(`Podium%` = prob_top3)
top_contenders[[paste0("Men Race ", race_num, " - Podium")]] <- podium_contenders
}
}
# Process ladies' results if available
if(!is.null(ladies_results) && !is.null(ladies_results$position_predictions)) {
ladies_positions <- ladies_results$position_predictions
ladies_races <- unique(ladies_positions$Race)
for(race_num in ladies_races) {
race_df <- ladies_positions %>%
filter(Race == race_num)
# Top 5 for win probability
win_contenders <- race_df %>%
arrange(desc(prob_top1)) %>%
head(5) %>%
dplyr::select(Skier, Nation, prob_top1) %>%
rename(`Win%` = prob_top1)
top_contenders[[paste0("Ladies Race ", race_num, " - Win")]] <- win_contenders
# Top 5 for podium probability
podium_contenders <- race_df %>%
arrange(desc(prob_top3)) %>%
head(5) %>%
dplyr::select(Skier, Nation, prob_top3) %>%
rename(`Podium%` = prob_top3)
top_contenders[[paste0("Ladies Race ", race_num, " - Podium")]] <- podium_contenders
}
}
if(length(top_contenders) > 0) {
output_file <- file.path(dir_path, "top_contenders.xlsx")
write.xlsx(top_contenders, output_file)
log_info(paste("Top contenders summary saved to", output_file))
}
return(top_contenders)
}
# Run the enhanced race day predictions workflow
run_race_day_predictions <- function() {
log_info("Running enhanced race day predictions workflow")
results <- list()
# Run for men if we have men's races
if(nrow(men_races) > 0 && nrow(men_startlist) > 0) {
log_info("Processing men's race day predictions")
results$men <- predict_races("men")
} else {
log_info("No men's races or startlist for today")
results$men <- NULL
}
# Run for ladies if we have ladies' races
if(nrow(ladies_races) > 0 && nrow(ladies_startlist) > 0) {
log_info("Processing ladies' race day predictions")
results$ladies <- predict_races("ladies")
} else {
log_info("No ladies' races or startlist for today")
results$ladies <- NULL
}
# Create top contenders summary
if(!is.null(results$men) || !is.null(results$ladies)) {
log_info("Creating top contenders summary")
results$top_contenders <- create_top_contenders_summary(results$men, results$ladies)
}
# Display summary
log_info("Enhanced race day prediction workflow complete")
# Display points summary
if(!is.null(results$men)) {
cat("\nMen's Race Day Points Predictions Summary:\n")
cat("Top 5 predicted performers:\n")
print(results$men$post_predictions %>% head(5) %>% dplyr::select(Skier, Nation, `Total Points`))
# Display position probabilities summary
if(!is.null(results$men$position_predictions)) {
cat("\nMen's Position Probabilities Summary (Race 1):\n")
cat("Top 3 win contenders:\n")
win_summary_data <- results$men$position_predictions %>%
filter(Race == 1) %>%
arrange(desc(prob_top1)) %>%
head(3)
# Select columns based on what's available
if("prob_top5" %in% names(win_summary_data)) {
win_summary <- win_summary_data %>% dplyr::select(Skier, Nation, Win = prob_top1, Podium = prob_top3, Top5 = prob_top5)
} else {
win_summary <- win_summary_data %>% dplyr::select(Skier, Nation, Win = prob_top1, Podium = prob_top3, Top6 = prob_top6)
}
print(win_summary)
}
}
if(!is.null(results$ladies)) {
cat("\nLadies' Race Day Points Predictions Summary:\n")
cat("Top 5 predicted performers:\n")
print(results$ladies$post_predictions %>% head(5) %>% dplyr::select(Skier, Nation, `Total Points`))
# Display position probabilities summary
if(!is.null(results$ladies$position_predictions)) {
cat("\nLadies' Position Probabilities Summary (Race 1):\n")
cat("Top 3 win contenders:\n")
win_summary_data <- results$ladies$position_predictions %>%
filter(Race == 1) %>%
arrange(desc(prob_top1)) %>%
head(3)
# Select columns based on what's available
if("prob_top5" %in% names(win_summary_data)) {
win_summary <- win_summary_data %>% dplyr::select(Skier, Nation, Win = prob_top1, Podium = prob_top3, Top5 = prob_top5)
} else {
win_summary <- win_summary_data %>% dplyr::select(Skier, Nation, Win = prob_top1, Podium = prob_top3, Top6 = prob_top6)
}
print(win_summary)
}
}
# Display file locations
today_folder <- format(current_date, "%Y%m%d")
output_dir <- paste0("~/blog/daehl-e/content/post/cross-country/drafts/race-picks/", today_folder)
cat("\nFiles saved to:", output_dir, "\n")
# List saved files
if(dir.exists(output_dir)) {
saved_files <- list.files(output_dir, full.names = FALSE)
if(length(saved_files) > 0) {
cat("Saved files:\n")
for(file in saved_files) {
cat("  -", file, "\n")
}
}
}
return(results)
}
# Function to display detailed position probability analysis
display_position_analysis <- function(results) {
if(is.null(results)) {
cat("No results to analyze.\n")
return()
}
cat("\n=== DETAILED POSITION PROBABILITY ANALYSIS ===\n")
# Analyze men's results
if(!is.null(results$men) && !is.null(results$men$position_predictions)) {
cat("\n--- MEN'S POSITION ANALYSIS ---\n")
men_pos <- results$men$position_predictions
races <- unique(men_pos$Race)
for(race_num in races) {
cat(paste("\nRace", race_num, "Analysis:\n"))
race_data <- men_pos %>% filter(Race == race_num)
# Win probability analysis
cat("Win Probability Distribution:\n")
win_stats <- race_data %>%
summarise(
total_prob = sum(prob_top1, na.rm = TRUE),
mean_prob = mean(prob_top1, na.rm = TRUE),
max_prob = max(prob_top1, na.rm = TRUE),
top_skier = Skier[which.max(prob_top1)]
)
cat(sprintf("  Total probability: %.1f%% (should be 100%%)\n", win_stats$total_prob))
cat(sprintf("  Average probability: %.1f%%\n", win_stats$mean_prob))
cat(sprintf("  Highest probability: %.1f%% (%s)\n", win_stats$max_prob, win_stats$top_skier))
# Podium probability analysis
cat("Podium Probability Distribution:\n")
podium_stats <- race_data %>%
summarise(
total_prob = sum(prob_top3, na.rm = TRUE),
mean_prob = mean(prob_top3, na.rm = TRUE),
over_50 = sum(prob_top3 > 50, na.rm = TRUE)
)
cat(sprintf("  Total probability: %.1f%% (should be 300%%)\n", podium_stats$total_prob))
cat(sprintf("  Average probability: %.1f%%\n", podium_stats$mean_prob))
cat(sprintf("  Skiers with >50%% podium chance: %d\n", podium_stats$over_50))
# Top contenders
cat("Top 5 Win Contenders:\n")
top_contenders <- race_data %>%
arrange(desc(prob_top1)) %>%
head(5) %>%
{if("prob_top5" %in% names(.)) dplyr::select(., Skier, Nation, prob_top1, prob_top3, prob_top5) else dplyr::select(., Skier, Nation, prob_top1, prob_top3, prob_top6)}
print(top_contenders)
}
}
# Analyze ladies' results
if(!is.null(results$ladies) && !is.null(results$ladies$position_predictions)) {
cat("\n--- LADIES' POSITION ANALYSIS ---\n")
ladies_pos <- results$ladies$position_predictions
races <- unique(ladies_pos$Race)
for(race_num in races) {
cat(paste("\nRace", race_num, "Analysis:\n"))
race_data <- ladies_pos %>% filter(Race == race_num)
# Win probability analysis
cat("Win Probability Distribution:\n")
win_stats <- race_data %>%
summarise(
total_prob = sum(prob_top1, na.rm = TRUE),
mean_prob = mean(prob_top1, na.rm = TRUE),
max_prob = max(prob_top1, na.rm = TRUE),
top_skier = Skier[which.max(prob_top1)]
)
cat(sprintf("  Total probability: %.1f%% (should be 100%%)\n", win_stats$total_prob))
cat(sprintf("  Average probability: %.1f%%\n", win_stats$mean_prob))
cat(sprintf("  Highest probability: %.1f%% (%s)\n", win_stats$max_prob, win_stats$top_skier))
# Podium probability analysis
cat("Podium Probability Distribution:\n")
podium_stats <- race_data %>%
summarise(
total_prob = sum(prob_top3, na.rm = TRUE),
mean_prob = mean(prob_top3, na.rm = TRUE),
over_50 = sum(prob_top3 > 50, na.rm = TRUE)
)
cat(sprintf("  Total probability: %.1f%% (should be 300%%)\n", podium_stats$total_prob))
cat(sprintf("  Average probability: %.1f%%\n", podium_stats$mean_prob))
cat(sprintf("  Skiers with >50%% podium chance: %d\n", podium_stats$over_50))
# Top contenders
cat("Top 5 Win Contenders:\n")
top_contenders <- race_data %>%
arrange(desc(prob_top1)) %>%
head(5) %>%
{if("prob_top5" %in% names(.)) dplyr::select(., Skier, Nation, prob_top1, prob_top3, prob_top5) else dplyr::select(., Skier, Nation, prob_top1, prob_top3, prob_top6)}
print(top_contenders)
}
}
}
# Function to validate probability distributions
validate_probabilities <- function(results) {
cat("\n=== PROBABILITY VALIDATION ===\n")
validation_results <- list()
# Validate men's probabilities
if(!is.null(results$men) && !is.null(results$men$position_predictions)) {
cat("\nMen's Probability Validation:\n")
men_pos <- results$men$position_predictions
races <- unique(men_pos$Race)
for(race_num in races) {
race_data <- men_pos %>% filter(Race == race_num)
cat(paste("Race", race_num, ":\n"))
# Check each threshold
thresholds <- c(1, 3, 5, 10, 30)
for(threshold in thresholds) {
prob_col <- paste0("prob_top", threshold)
if(prob_col %in% names(race_data)) {
total_prob <- sum(race_data[[prob_col]], na.rm = TRUE)
expected_prob <- 100 * threshold
difference <- abs(total_prob - expected_prob)
status <- if(difference <= 1) "✓ GOOD" else if(difference <= 5) "⚠ WARNING" else "✗ ERROR"
cat(sprintf("  Top %d: %.1f%% (expected: %.0f%%) %s\n",
threshold, total_prob, expected_prob, status))
# Store validation result
validation_results[[paste0("men_race", race_num, "_top", threshold)]] <- list(
actual = total_prob,
expected = expected_prob,
difference = difference,
status = status
)
}
}
}
}
# Validate ladies' probabilities
if(!is.null(results$ladies) && !is.null(results$ladies$position_predictions)) {
cat("\nLadies' Probability Validation:\n")
ladies_pos <- results$ladies$position_predictions
races <- unique(ladies_pos$Race)
for(race_num in races) {
race_data <- ladies_pos %>% filter(Race == race_num)
cat(paste("Race", race_num, ":\n"))
# Check each threshold
thresholds <- c(1, 3, 5, 10, 30)
for(threshold in thresholds) {
prob_col <- paste0("prob_top", threshold)
if(prob_col %in% names(race_data)) {
total_prob <- sum(race_data[[prob_col]], na.rm = TRUE)
expected_prob <- 100 * threshold
difference <- abs(total_prob - expected_prob)
status <- if(difference <= 1) "✓ GOOD" else if(difference <= 5) "⚠ WARNING" else "✗ ERROR"
cat(sprintf("  Top %d: %.1f%% (expected: %.0f%%) %s\n",
threshold, total_prob, expected_prob, status))
# Store validation result
validation_results[[paste0("ladies_race", race_num, "_top", threshold)]] <- list(
actual = total_prob,
expected = expected_prob,
difference = difference,
status = status
)
}
}
}
}
return(validation_results)
}
# Main execution
log_info("Starting enhanced race day predictions workflow")
race_day_results <- run_race_day_predictions()
# Display detailed analysis
display_position_analysis(race_day_results)
# Validate probabilities
validation_results <- validate_probabilities(race_day_results)
log_info("Enhanced race day predictions complete")
# Final summary
cat("\n=== FINAL SUMMARY ===\n")
cat("Enhanced race day predictions completed successfully.\n")
cat("Generated both points predictions and position probabilities.\n")
if(!is.null(race_day_results$men)) {
cat("✓ Men's predictions generated\n")
}
if(!is.null(race_day_results$ladies)) {
cat("✓ Ladies' predictions generated\n")
}
if(!is.null(race_day_results$top_contenders)) {
cat("✓ Top contenders summary created\n")
}
today_folder <- format(current_date, "%Y%m%d")
output_dir <- paste0("~/blog/daehl-e/content/post/cross-country/drafts/race-picks/", today_folder)
cat("\nAll files saved to:", output_dir, "\n")
cat("Ready for blog publication!\n")
