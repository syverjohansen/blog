# Cross-Country Season Prediction Script Documentation

This document provides detailed explanations of each section in the 2026 cross-country season prediction R script, explaining the purpose, implementation, and reasoning behind each component.

## Section: {r load-data} - Data Loading & Validation

### Purpose
This section is responsible for loading the core chronometer data files that contain race results for cross-country skiing and performing comprehensive validation to ensure data quality and integrity before any analysis begins.

### Data Sources
The section loads two primary CSV files:
- **Men's data**: `/Users/syverjohansen/ski/elo/python/ski/polars/excel365/men_chrono.csv`
- **Ladies data**: `/Users/syverjohansen/ski/elo/python/ski/polars/excel365/ladies_chrono.csv`

These files contain chronological race data generated by the ELO rating system pipeline, with each row representing a single race result for a skier.

### Implementation Details

#### 1. File Existence Validation
```r
if (!file.exists(men_file)) stop("Men's data file not found: ", men_file)
if (!file.exists(ladies_file)) stop("Ladies data file not found: ", ladies_file)
```
**Purpose**: Ensures the data files exist before attempting to load them. This prevents cryptic errors later and provides clear feedback if the data pipeline hasn't run or files have been moved.

#### 2. Safe Data Loading with Error Handling
```r
tryCatch({
  M_chrono <- read_csv(men_file, show_col_types = FALSE)
  cat("✓ Men's data loaded:", nrow(M_chrono), "rows\n")
}, error = function(e) {
  stop("Failed to load men's data: ", e$message)
})
```
**Purpose**: Uses `tryCatch()` to handle potential file corruption, permission issues, or formatting problems. The `show_col_types = FALSE` suppresses column type messages for cleaner output. Immediately reports the number of rows loaded for verification.

#### 3. Required Column Validation
```r
required_cols <- c("Skier", "Date", "Season", "Event", "City", "Distance", "Place", "Race", "ID")
missing_men <- setdiff(required_cols, names(M_chrono))
```
**Purpose**: Validates that all essential columns are present in the loaded data. These columns are critical for:
- **Skier**: Athlete identification
- **Date**: Race timing and chronological ordering
- **Season**: Season grouping for analysis
- **Event**: Race type classification (World Cup, Tour de Ski, etc.)
- **City**: Race location for context
- **Distance**: Race distance for categorization
- **Place**: Finishing position for points calculation
- **Race**: Race identifier within the broader dataset
- **ID**: Unique skier identifier for linking with other datasets

#### 4. Data Quality Validation

##### Place Column Validation
```r
invalid_places_m <- sum(is.na(M_chrono$Place) | M_chrono$Place < 0 | !is.finite(M_chrono$Place))
if (invalid_places_m > nrow(M_chrono) * 0.1) {
  warning("More than 10% of men's Place values are invalid")
}
```
**Purpose**: Validates that finishing places are logical (positive integers). The 10% threshold allows for some data imperfections (DNS, DSQ, etc.) while flagging systematic data quality issues.

##### Skier Name Validation
```r
missing_skiers_m <- sum(is.na(M_chrono$Skier) | M_chrono$Skier == "")
if (missing_skiers_m > 0) warning("Men's data has missing skier names")
```
**Purpose**: Ensures all race results can be attributed to specific athletes. Missing skier names would break the analysis pipeline.

##### Date Validation
```r
date_errors_m <- sum(is.na(M_chrono$Date))
```
**Purpose**: Validates that race dates are present, which is essential for chronological analysis and season grouping.

#### 5. Athlete Exclusion System
```r
excluded_men <- c("Jonas Baumann", "Pål Golberg", "Mikael Gunnulfsen", "Renaud Jay", "Roman Schaad")
excluded_ladies <- c("Therese Johaug", "Victoria Carl")
```
**Purpose**: Removes specific athletes from analysis for various reasons:
- **Retirement**: Athletes who have retired and won't compete in 2026
- **Data Quality**: Athletes with inconsistent or problematic data
- **Special Circumstances**: Athletes with unique situations that would skew predictions

The exclusion is tracked and validated:
```r
excluded_count_m <- sum(M_chrono$Skier %in% excluded_men)
actual_excluded_m <- M_chrono_original_rows - nrow(M_chrono)
if (actual_excluded_m != excluded_count_m) {
  warning("Mismatch in men's exclusion: expected ", excluded_count_m, ", actual ", actual_excluded_m)
}
```
This ensures the exclusion worked correctly and no unexpected data loss occurred.

#### 6. World Cup Points System Setup
The section defines three different points systems used in cross-country skiing:

##### Standard World Cup Points (50 positions)
```r
wc_points <- c(100,95,90,85,80,75,72,69,66,63,60,58,56,54,52,50,48,46,44,42,40,38,36,34,32,30,28,26,24,22,20,19,18,17,16,15,14,13,12,11,10,9,8,7,6,5,4,3,2,1)
```
**Purpose**: Standard FIS World Cup points awarded for top 50 finishes in regular World Cup races.

##### Stage Race Points (30 positions)
```r
stage_points <- c(50,47,44,41,38,35,32,30,28,26,24,22,20,18,16,15,14,13,12,11,10,9,8,7,6,5,4,3,2,1)
```
**Purpose**: Reduced points for stage race components (like individual Tour de Ski stages).

##### Tour de Ski Points (49 positions)
```r
tds_points <- c(300,285,270,255,240,216,207,198,189,180,174,168,162,156,150,144,138,132,126,120,114,108,102,96,90,84,78,72,66,60,57,54,51,48,45,42,39,36,33,30,27,24,21,18,15,12,9,6,3)
```
**Purpose**: Enhanced points for the prestigious Tour de Ski overall classification.

#### 7. Points System Validation
```r
if (length(wc_points) != 50) stop("World Cup points array should have 50 values")
if (!all(diff(wc_points) <= 0)) stop("World Cup points not in descending order")
```
**Purpose**: Validates that points arrays have the correct length and are in descending order (higher places get more points).

#### 8. Safe Points Retrieval Function
```r
get_points <- function(place, points_list) {
  if (is.na(place) || !is.finite(place)) {
    return(0)
  }
  if (place >= 1 && place <= length(points_list)) {
    return(points_list[place])
  }
  return(0)
}
```
**Purpose**: Creates a robust function for retrieving points that handles edge cases:
- **Invalid places** (NA, infinite values): Returns 0 points
- **Out-of-range places** (beyond points positions): Returns 0 points
- **Valid places**: Returns correct points from the appropriate array

#### 9. Function Testing
```r
test_cases <- c(1, 10, 50, 51, -1, NA, Inf)
for (test_place in test_cases) {
  result <- get_points(test_place, wc_points)
  cat(sprintf("  Place %s -> %s points\n", 
              ifelse(is.na(test_place), "NA", as.character(test_place)), result))
}
```
**Purpose**: Tests the `get_points()` function with edge cases to ensure it handles all scenarios correctly before it's used throughout the analysis.

#### 10. Final Data Summary
```r
cat(sprintf("Final dataset sizes: Men %d rows, Ladies %d rows\n", nrow(M_chrono), nrow(L_chrono)))
cat(sprintf("Men's unique skiers: %d\n", length(unique(M_chrono$Skier))))
cat(sprintf("Ladies unique skiers: %d\n", length(unique(L_chrono$Skier))))
cat(sprintf("Men's season range: %s - %s\n", min(M_chrono$Season, na.rm = TRUE), max(M_chrono$Season, na.rm = TRUE)))
```
**Purpose**: Provides a comprehensive summary of the loaded and cleaned data, including:
- Total number of race results
- Number of unique athletes in each dataset
- Season range covered by the data

### Key Design Principles

1. **Fail Fast**: Immediate validation prevents errors from propagating through the analysis
2. **Comprehensive Logging**: Detailed output helps with debugging and verification
3. **Defensive Programming**: Handles edge cases and unexpected data conditions
4. **Data Integrity**: Multiple validation layers ensure data quality
5. **Transparency**: Clear reporting of what data was excluded and why

### Output Variables
- **M_chrono**: Cleaned men's chronometer data ready for processing
- **L_chrono**: Cleaned ladies' chronometer data ready for processing
- **wc_points, stage_points, tds_points**: Validated points arrays for different race types
- **get_points()**: Function for safe points retrieval throughout the analysis
- **excluded_men, excluded_ladies**: Lists of excluded athletes for reference

This section establishes the foundation for all subsequent analysis by ensuring clean, validated, and properly formatted data.