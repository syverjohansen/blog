{{/* layouts/biathlon/partials/skier-table.html */}}
<div id="biathlon-toggle-buttons" class="mb-3">
    <button id="biathlon-elo-mode-btn" class="btn btn-primary mr-2">Elo Mode</button>
    <button id="biathlon-percent-mode-btn" class="btn btn-secondary">Percent of Max Mode</button>
</div>

<div id="biathlon-loading-indicator" class="text-center mb-3">
    <p>Loading skier data...</p>
</div>

<div class="table-responsive">
    <table id="biathlonDataTable" class="display table table-striped table-bordered">
        <thead>
            <!-- Headers will be dynamically populated -->
        </thead>
        <tbody>
            <!-- Data will be dynamically populated -->
        </tbody>
    </table>
</div>

<script type="text/javascript" src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/fixedcolumns/5.0.1/js/dataTables.fixedColumns.min.js"></script>

<script>
    $(document).ready(function() {
        // Extract sex and ID from the URL
        const urlParams = new URLSearchParams(window.location.search);
        const sex = urlParams.get('gender')?.toUpperCase();
        const id = urlParams.get('id');

        let skierData = null;
        let table;
        let hasPercentageData = false;

        // Column definitions for Elo Mode - Biathlon disciplines
        const eloColumns = [
            'Date', 'City', 'Country', 'Event', 'RaceType', 'Place', 'Season', 'Race', 'Age', 
            'Elo', 'Sprint_Elo', 'Pursuit_Elo', 'Individual_Elo', 'MassStart_Elo'
        ];

        // Column definitions for Percent of Max Mode - Biathlon disciplines
        const pctColumns = [
            'Date', 'City', 'Country', 'Event', 'RaceType', 'Place', 'Season', 'Race', 'Age', 
            'Elo_Pct', 'Sprint_Elo_Pct', 'Pursuit_Elo_Pct', 'Individual_Elo_Pct', 'MassStart_Elo_Pct'
        ];

        // Function to format data from the structure
        function formatSkierData(groupData, id) {
            const rawData = groupData[id];
            if (!rawData) {
                return [];
            }
            
            // Transform the data into an array of objects
            const dataArray = [];
            const keys = Object.keys(rawData);
            const rowCount = rawData[keys[0]].length;
            
            // Check if percentage columns exist
            hasPercentageData = keys.some(key => key.endsWith('_Pct'));
            
            if (!hasPercentageData) {
                // If percentage columns don't exist, we need to calculate them on the fly
                // Add percentage columns for each Elo column
                const eloKeys = keys.filter(key => key.includes('Elo') && !key.includes('_Pct'));
                
                eloKeys.forEach(eloKey => {
                    const pctKey = `${eloKey}_Pct`;
                    
                    // Get all values for this Elo column
                    const eloValues = rawData[eloKey];
                    
                    // Find the maximum value
                    const maxElo = Math.max(...eloValues.map(val => parseFloat(val) || 0));
                    
                    // Calculate percentages
                    if (maxElo > 0) {
                        rawData[pctKey] = eloValues.map(val => {
                            const elo = parseFloat(val) || 0;
                            return ((elo / maxElo) * 100).toFixed(2);
                        });
                    } else {
                        rawData[pctKey] = Array(eloValues.length).fill(0);
                    }
                });
                
                // Now we have percentage columns
                hasPercentageData = true;
            }
            
            for (let i = 0; i < rowCount; i++) {
                const rowObj = {};
                keys.forEach(key => {
                    rowObj[key] = rawData[key][i];
                });
                dataArray.push(rowObj);
            }
            
            return dataArray;
        }

        // Function to initialize DataTable
        function initializeDataTable(data, columnsToShow) {
            // Verify which columns actually exist in the data
            if (data.length > 0) {
                const availableColumns = Object.keys(data[0]);
                // Filter out missing columns
                columnsToShow = columnsToShow.filter(col => availableColumns.includes(col));
            }

            // Filter the data to only show columns present in the `columnsToShow` array
            const columns = columnsToShow.map(function(key) {
                let title = key;
                
                // Create more readable column titles for biathlon disciplines
                const titleMap = {
                    'Sprint_Elo': 'Sprint',
                    'Pursuit_Elo': 'Pursuit',
                    'Individual_Elo': 'Individual',
                    'MassStart_Elo': 'Mass Start',
                    'Sprint_Elo_Pct': 'Sprint %',
                    'Pursuit_Elo_Pct': 'Pursuit %',
                    'Individual_Elo_Pct': 'Individual %',
                    'MassStart_Elo_Pct': 'Mass Start %',
                    'Elo_Pct': 'Overall %'
                };
                
                if (titleMap[key]) {
                    title = titleMap[key];
                } else {
                    title = key.replace(/_/g, ' ').charAt(0).toUpperCase() + key.slice(1).replace(/_/g, ' ');
                }
                
                const columnDef = {
                    data: key,
                    title: title,
                    visible: key !== 'ID',
                    className: key.includes('Elo') ? 'text-right' : '',
                    orderSequence: key.includes('Elo') ? ['desc', 'asc'] : ['asc', 'desc']
                };
                
                // Add render function for Elo columns and Age to remove decimals
                if (key.includes('Elo') || key === 'Age') {
                    columnDef.render = function(data, type, row) {
                        if (type === 'display' || type === 'filter') {
                            // For display and filtering, convert to integer
                            if (key.includes('_Pct')) {
                                return data ? Math.round(parseFloat(data)) + '%' : data;
                            } else {
                                return data ? Math.round(parseFloat(data)) : data;
                            }
                        }
                        // For sorting and other operations, use the original value
                        return data;
                    };
                }
                
                return columnDef;
            });

            if (table) {
                table.clear();
                table.destroy();
            }

            try {
                table = $('#biathlonDataTable').DataTable({
                    data: data,
                    columns: columns,
                    fixedColumns: { 
                        left: 2 
                    },
                    scrollX: true,
                    scrollY: '400px',
                    scrollCollapse: true,
                    paging: false,
                    order: [[0, 'desc']] // Sort by date descending (most recent first)
                });
            } catch (error) {
                $('#biathlonDataTable').html('<tr><td colspan="14">Error initializing data table</td></tr>');
            }
        }

        // Function to fetch skier group
        async function fetchSkierGroup(sex, id) {
            const lookupUrl = `/python/biathlon/excel365/${sex}_skiers_lookup.json`;
            console.log(`Fetching lookup from: ${lookupUrl}`);
            try {
                const response = await fetch(lookupUrl);
                if (!response.ok) {
                    throw new Error(`Failed to fetch skier lookup: ${response.status}`);
                }
                const skiersList = await response.json();
                console.log(`Loaded ${skiersList.length} skiers from lookup`);
                console.log('First few lookup entries:', skiersList.slice(0, 3));
                
                const skierInfo = skiersList.find(skier => skier.id === parseInt(id));
                
                if (!skierInfo) {
                    console.log(`Available IDs in lookup:`, skiersList.map(s => s.id).slice(0, 20));
                    throw new Error(`Skier with ID ${id} not found in lookup table`);
                }
                
                console.log('Found skier in lookup:', skierInfo);
                return skierInfo.group;
            } catch (error) {
                console.error('Error in fetchSkierGroup:', error);
                return null;
            }
        }

        // Function to fetch skier data
        async function fetchSkierData(sex, id) {
            $('#biathlon-loading-indicator').show();
            
            try {
                console.log(`Fetching skier group for ${sex} ID ${id}`);
                
                // Fetch the skier's group
                const group = await fetchSkierGroup(sex, id);
                
                if (!group) {
                    throw new Error('Could not determine skier group');
                }
                
                console.log(`Found group: ${group}`);
                
                // Fetch the group data file using the group key
                const groupUrl = `/python/biathlon/excel365/${sex}/skiers_${group}.json`;
                console.log(`Fetching group data from: ${groupUrl}`);
                
                const response = await fetch(groupUrl);
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch group data: ${response.status}`);
                }
                
                const groupData = await response.json();
                console.log(`Group data contains ${Object.keys(groupData).length} skiers`);
                console.log(`Available skier IDs in group:`, Object.keys(groupData).slice(0, 10));
                
                // Extract and format this skier's data
                skierData = formatSkierData(groupData, id);
                
                if (!skierData || skierData.length === 0) {
                    throw new Error(`No data found for skier ID ${id} in group ${group}`);
                }
                
                console.log(`Formatted skier data: ${skierData.length} records`);
                
                // Initialize with default mode (Elo)
                initializeDataTable(skierData, eloColumns);
                
                // Tell the radar chart that data is loaded (via custom event)
                const dataLoadedEvent = new CustomEvent('skierDataLoaded', {
                    detail: { 
                        skierData: skierData,
                        sex: sex,
                        id: id
                    }
                });
                document.dispatchEvent(dataLoadedEvent);
                
            } catch (error) {
                console.error('Error details:', error);
                $('#biathlonDataTable').html('<tr><td colspan="14">Error loading skier data. Please try again later.</td></tr>');
            } finally {
                $('#biathlon-loading-indicator').hide();
            }
        }

        // Load initial data
        if (sex && id) {
            fetchSkierData(sex, id);
        } else {
            $('#biathlon-loading-indicator').hide();
            $('#biathlonDataTable').html('<tr><td colspan="14">Missing gender or ID parameters</td></tr>');
        }

        // Event listeners for mode buttons
        $('#biathlon-elo-mode-btn').click(function() {
            $(this).addClass('btn-primary').removeClass('btn-secondary');
            $('#biathlon-percent-mode-btn').addClass('btn-secondary').removeClass('btn-primary');
            if (skierData) {
                initializeDataTable(skierData, eloColumns);
            }
        });

        $('#biathlon-percent-mode-btn').click(function() {
            $(this).addClass('btn-primary').removeClass('btn-secondary');
            $('#biathlon-elo-mode-btn').addClass('btn-secondary').removeClass('btn-primary');
            if (skierData) {
                initializeDataTable(skierData, pctColumns);
            }
        });
    });
</script>