<!-- Ladies Biathlon ELO Chart Section -->
<div class="container-fluid mt-4">
    <h2>Ladies Biathlon Elo Chart</h2>
    
    <!-- Controls -->
    <div class="row mb-3">
        <div class="col-md-6">
            <h4>Search Skiers</h4>
            <input type="text" id="ladies-biathlon-search-box" class="form-control" placeholder="Search for athletes...">
            <div id="ladies-biathlon-menu" class="skier-menu mt-2" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px;">
                <!-- Athlete checkboxes will be populated here -->
            </div>
        </div>
        
        <div class="col-md-6">
            <h4>Chart Options</h4>
            
            <!-- X-Axis Options -->
            <div class="mb-2">
                <label class="form-label">X-Axis:</label><br>
                <input type="radio" name="ladies-biathlon-x-axis" id="ladies-biathlon-x-date" value="Date" checked>
                <label for="ladies-biathlon-x-date">Date</label><br>
                <input type="radio" name="ladies-biathlon-x-axis" id="ladies-biathlon-x-exp" value="Exp">
                <label for="ladies-biathlon-x-exp">Career Experience</label><br>
                <input type="radio" name="ladies-biathlon-x-axis" id="ladies-biathlon-x-age" value="Age">
                <label for="ladies-biathlon-x-age">Age</label><br>

            </div>
            
            <!-- Y-Axis Options -->
            <div class="mb-2">
                <label class="form-label">Y-Axis:</label><br>
                <input type="radio" name="ladies-biathlon-y-axis" id="ladies-biathlon-y-elo" value="Elo" checked>
                <label for="ladies-biathlon-y-elo">Elo Rating</label><br>
                <input type="radio" name="ladies-biathlon-y-axis" id="ladies-biathlon-y-pct" value="Pct">
                <label for="ladies-biathlon-y-pct">Elo Percentage</label>
            </div>
            
            <!-- Discipline Options -->
            <div class="mb-2">
                <label class="form-label">Discipline:</label><br>
                <input type="radio" name="ladies-biathlon-discipline" id="ladies-biathlon-disc-overall" value="Overall" checked>
                <label for="ladies-biathlon-disc-overall">Overall</label><br>
                <input type="radio" name="ladies-biathlon-discipline" id="ladies-biathlon-disc-sprint" value="Sprint">
                <label for="ladies-biathlon-disc-sprint">Sprint</label><br>
                <input type="radio" name="ladies-biathlon-discipline" id="ladies-biathlon-disc-pursuit" value="Pursuit">
                <label for="ladies-biathlon-disc-pursuit">Pursuit</label><br>
                <input type="radio" name="ladies-biathlon-discipline" id="ladies-biathlon-disc-individual" value="Individual">
                <label for="ladies-biathlon-disc-individual">Individual</label><br>
                <input type="radio" name="ladies-biathlon-discipline" id="ladies-biathlon-disc-massstart" value="MassStart">
                <label for="ladies-biathlon-disc-massstart">Mass Start</label>
            </div>
            
            <!-- Smoothing Options -->
            <div class="mb-2">
                <label class="form-label">Line Smoothing:</label><br>
                <input type="radio" name="ladies-biathlon-smoothing" id="ladies-biathlon-smooth-low" value="0.1">
                <label for="ladies-biathlon-smooth-low">Sharp (0.1)</label><br>
                <input type="radio" name="ladies-biathlon-smoothing" id="ladies-biathlon-smooth-medium" value="0.4" checked>
                <label for="ladies-biathlon-smooth-medium">Medium (0.4)</label><br>
                <input type="radio" name="ladies-biathlon-smoothing" id="ladies-biathlon-smooth-high" value="0.7">
                <label for="ladies-biathlon-smooth-high">Smooth (0.7)</label><br>
                <input type="radio" name="ladies-biathlon-smoothing" id="ladies-biathlon-smooth-very-high" value="1.0">
                <label for="ladies-biathlon-smooth-very-high">Very Smooth (1.0)</label>
            </div>
            
            <!-- Data Filtering Options -->
            <div class="mb-2">
                <label class="form-label">Data Filtering:</label><br>
                <input type="radio" name="ladies-biathlon-filtering" id="ladies-biathlon-filter-none" value="none" checked>
                <label for="ladies-biathlon-filter-none">All Points</label><br>
                <input type="radio" name="ladies-biathlon-filtering" id="ladies-biathlon-filter-every-2" value="2">
                <label for="ladies-biathlon-filter-every-2">Every 2nd Point</label><br>
                <input type="radio" name="ladies-biathlon-filtering" id="ladies-biathlon-filter-every-3" value="3">
                <label for="ladies-biathlon-filter-every-3">Every 3rd Point</label><br>
                <input type="radio" name="ladies-biathlon-filtering" id="ladies-biathlon-filter-every-5" value="5">
                <label for="ladies-biathlon-filter-every-5">Every 5th Point</label>
            </div>
            
            <button id="ladies-biathlon-generate-chart" class="btn btn-primary">Generate Chart</button>
        </div>
    </div>
    
    <!-- Loading Indicator -->
    <div id="ladies-biathlon-loading-indicator" style="display: none; text-align: center; margin: 20px;">
        Loading athlete data...
    </div>
    
    <!-- Chart Container -->
    <div id="ladies-biathlon-chart-container">
        <canvas id="ladiesBiathlonChart"></canvas>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script>
    let ladiesBiathlonChart = null;
    const selectedLadiesBiathlonAthletes = new Set();
    let ladiesBiathlonAthleteMap = {}; // Store ID to name mapping
    let ladiesBiathlonAthleteLookupData = []; // Store athlete lookup data

    // Get base path from Hugo
    const ladiesBiathlonBasePath = '{{ "python/biathlon/excel365/" | relURL }}';
    
    // Initialize the application
    async function initializeLadiesBiathlonApp() {
        try {
            console.log('üîÑ Starting ladies\'s biathlon initialization...', new Date().toLocaleTimeString());
            console.log('üìÇ Ladies\'s biathlon base path:', ladiesBiathlonBasePath);
            console.log('üåê Current URL:', window.location.href);
            
            // Fetch athlete IDs and names from L_all_ids.json
            const idsUrl = ladiesBiathlonBasePath + 'L_all_ids.json';
            console.log('üì• Attempting to fetch ladies\'s biathlon IDs from:', idsUrl);
            
            const idsResponse = await fetch(idsUrl);
            console.log('üìä Ladies\'s biathlon IDs response status:', idsResponse.status, idsResponse.statusText);
            
            if (!idsResponse.ok) {
                console.error('‚ùå Failed to fetch ladies\'s biathlon IDs. Response headers:', [...idsResponse.headers]);
                throw new Error(`Failed to fetch IDs: ${idsResponse.status} ${idsResponse.statusText}`);
            }
            
            const idsData = await idsResponse.json();
            const idsCount = Object.keys(idsData).length;
            console.log('üë• Successfully loaded', idsCount, 'ladies biathlon athletes from IDs file');
            
            if (idsCount > 0) {
                const firstThree = Object.entries(idsData).slice(0, 3);
                console.log('üéØ First few ladies biathlon athletes:', firstThree.map(([id, name]) => `ID: ${id} (${typeof id}) ‚Üí Name: "${name}"`));
            }
            
            ladiesBiathlonAthleteMap = Object.fromEntries(Object.entries(idsData));
            
            // Fetch athlete lookup data for grouping info
            const lookupUrl = ladiesBiathlonBasePath + 'L_skiers_lookup.json';
            console.log('üì• Attempting to fetch ladies\'s biathlon lookup data from:', lookupUrl);
            
            const lookupResponse = await fetch(lookupUrl);
            console.log('üìä Ladies\'s biathlon lookup response status:', lookupResponse.status, lookupResponse.statusText);
            
            if (!lookupResponse.ok) {
                console.error('‚ùå Failed to fetch ladies\'s biathlon lookup data');
                throw new Error(`Failed to fetch lookup data: ${lookupResponse.status} ${lookupResponse.statusText}`);
            }
            
            const lookupData = await lookupResponse.json();
            console.log('üîç Successfully loaded', lookupData.length, 'entries from ladies\'s biathlon lookup data');
            
            // Show some sample lookup entries
            if (lookupData.length > 0) {
                const sampleLookup = lookupData.slice(0, 3);
                console.log('üìã Sample ladies\'s biathlon lookup entries:', sampleLookup.map(entry => 
                    `ID: ${entry.id} (${typeof entry.id}) ‚Üí Skier: "${entry.skier}" ‚Üí Group: "${entry.group}"`
                ));
            }
            
            ladiesBiathlonAthleteLookupData = lookupData;
            
            // Set up UI elements
            console.log('üé® Setting up ladies\'s biathlon UI elements...');
            setupLadiesBiathlonUI(idsData);
            
            console.log('‚úÖ Ladies\'s biathlon initialization completed successfully at', new Date().toLocaleTimeString());
            
        } catch (error) {
            console.error('‚ùå LADIES\'S BIATHLON INITIALIZATION ERROR:', error.message);
            console.error('Stack trace:', error.stack);
            alert(`Error loading ladies's biathlon athlete data: ${error.message}`);
        }
    }
    
    function setupLadiesBiathlonUI(idsData) {
        const athleteMenu = document.getElementById('ladies-biathlon-menu');
        const searchBox = document.getElementById('ladies-biathlon-search-box');
        const generateChartButton = document.getElementById('ladies-biathlon-generate-chart');
        
        const athleteData = Object.entries(idsData);
        
        const renderAthletes = (filter = "") => {
            athleteMenu.innerHTML = "";
            const selected = athleteData.filter(([id]) => selectedLadiesBiathlonAthletes.has(id));
            const unselected = athleteData.filter(([id, name]) => 
                !selectedLadiesBiathlonAthletes.has(id) && 
                name.toLowerCase().includes(filter.toLowerCase())
            );
            
            // Render selected athletes first
            selected.forEach(([id, name]) => {
                const label = document.createElement('label');
                label.style.display = 'block';
                label.innerHTML = `<input type="checkbox" class="ladies-biathlon-checkbox" value="${id}" checked> ${name}`;
                athleteMenu.appendChild(label);
            });
            
            // Render filtered unselected athletes
            unselected.forEach(([id, name]) => {
                const label = document.createElement('label');
                label.style.display = 'block';
                label.innerHTML = `<input type="checkbox" class="ladies-biathlon-checkbox" value="${id}"> ${name}`;
                athleteMenu.appendChild(label);
            });
        };
        
        // Initial render with all athletes
        renderAthletes();
        
        // Set up event listeners
        searchBox.addEventListener('input', (event) => {
            renderAthletes(event.target.value);
        });
        
        athleteMenu.addEventListener('change', (event) => {
            if (event.target.classList.contains('ladies-biathlon-checkbox')) {
                const athleteId = event.target.value;
                if (event.target.checked) {
                    selectedLadiesBiathlonAthletes.add(athleteId);
                } else {
                    selectedLadiesBiathlonAthletes.delete(athleteId);
                }
            }
        });
        
        generateChartButton.addEventListener('click', () => {
            generateLadiesBiathlonChart();
        });
    }
    
    // Function to load data for an athlete from the grouped files
    async function fetchLadiesBiathlonAthleteData(athleteId) {
        // Find athlete in lookup data to get the group
        const athleteInfo = ladiesBiathlonAthleteLookupData.find(a => a.id === parseInt(athleteId));
        
        if (!athleteInfo) {
            console.error('‚ùå Ladies\'s biathlon athlete with ID', athleteId, 'not found in lookup data');
            return null;
        }
        
        console.log('üéØ Processing ladies\'s biathlon athlete:', athleteInfo.skier, '(ID:', athleteId, ', Group:', athleteInfo.group + ')');
        
        // Use the group name directly for the filename
        const groupFileName = athleteInfo.group;
        const fileUrl = `${ladiesBiathlonBasePath}L/skiers_${groupFileName}.json`;
        
        console.log('üìÇ Fetching ladies\'s biathlon data from:', fileUrl);
        
        // Fetch group data using the base path
        try {
            const response = await fetch(fileUrl);
            console.log('üìä Ladies\'s biathlon file response status:', response.status);
            
            if (!response.ok) {
                console.error('‚ùå Failed to fetch ladies\'s biathlon group data:', response.status);
                throw new Error(`Failed to fetch group data: ${response.status}`);
            }
            
            const groupData = await response.json();
            console.log('üìÅ Ladies\'s biathlon group file contains', Object.keys(groupData).length, 'athletes');
            
            // Extract this athlete's data
            const athleteData = groupData[athleteId];
            
            if (!athleteData) {
                console.error('‚ùå No data found for ladies\'s biathlon athlete ID', athleteId, 'in group data');
                console.log('üîç Available athlete IDs in this group:', Object.keys(groupData).slice(0, 10));
                return null;
            }
            
            // Transform data into array of objects
            const result = [];
            const keys = Object.keys(athleteData);
            const rowCount = athleteData[keys[0]].length;
            
            console.log('üìà Found', rowCount, 'data points for ladies\'s biathlon', athleteInfo.skier);
            
            for (let i = 0; i < rowCount; i++) {
                const rowObj = {};
                keys.forEach(key => {
                    rowObj[key] = athleteData[key][i];
                });
                result.push(rowObj);
            }
            
            console.log('‚úÖ Successfully processed data for ladies\'s biathlon', athleteInfo.skier);
            return result;
        } catch (error) {
            console.error('‚ùå Error fetching data for ladies\'s biathlon athlete', athleteId + ':', error.message);
            return null;
        }
    }
    
    async function generateLadiesBiathlonChart() {
        console.log('üöÄ Starting ladies\'s biathlon chart generation...');
        
        const selectedAthleteIds = Array.from(document.querySelectorAll('.ladies-biathlon-checkbox:checked')).map(cb => cb.value);
        console.log('üë• Selected', selectedAthleteIds.length, 'ladies biathlon athletes:', selectedAthleteIds);
        
        if (selectedAthleteIds.length === 0) {
            alert('Please select at least one athlete');
            return;
        }
        
        const xAxis = document.querySelector('input[name="ladies-biathlon-x-axis"]:checked').value;
        const yAxis = document.querySelector('input[name="ladies-biathlon-y-axis"]:checked').value;
        const discipline = document.querySelector('input[name="ladies-biathlon-discipline"]:checked').value;
        const smoothing = parseFloat(document.querySelector('input[name="ladies-biathlon-smoothing"]:checked').value);
        const filtering = document.querySelector('input[name="ladies-biathlon-filtering"]:checked').value;
        
        console.log('‚öôÔ∏è Ladies\'s biathlon chart settings - X:', xAxis, ', Y:', yAxis, ', Discipline:', discipline, ', Smoothing:', smoothing, ', Filtering:', filtering);
        
        // Show loading indicator
        document.getElementById('ladies-biathlon-loading-indicator').style.display = 'block';
        
        // Determine the correct Elo field based on selected discipline
        let eloField;
        if (discipline === "Overall") {
            eloField = "Elo";
        } else if (discipline === "Sprint") {
            eloField = "Sprint_Elo";
        } else if (discipline === "Pursuit") {
            eloField = "Pursuit_Elo";
        } else if (discipline === "Individual") {
            eloField = "Individual_Elo";
        } else if (discipline === "MassStart") {
            eloField = "MassStart_Elo";
        }
        
        console.log('üìä Using ladies\'s biathlon Elo field:', eloField);
        
        try {
            // Fetch data for each selected athlete
            console.log('üì• Fetching data for selected ladies biathlon athletes...');
            const athletesData = await Promise.all(selectedAthleteIds.map(fetchLadiesBiathlonAthleteData));
            
            console.log('‚úÖ Ladies\'s biathlon data fetch complete. Processing results...');
            
            // Process the data
            const allData = [];
            athletesData.forEach((athleteData, index) => {
                if (!athleteData) {
                    console.warn('‚ö†Ô∏è No data for ladies\'s biathlon athlete', selectedAthleteIds[index]);
                    return;
                }
                
                const athleteId = selectedAthleteIds[index];
                let validPoints = 0;
                athleteData.forEach(entry => {
                    const isPct = (yAxis === 'Pct');
                    const eloValue = isPct ? entry[`${eloField}_Pct`] : entry[eloField];
                    
                    if (eloValue !== null && eloValue !== undefined) {
                        validPoints++;
                        allData.push({
                            athleteId: athleteId,
                            athleteName: ladiesBiathlonAthleteMap[athleteId],
                            date: entry.Date,
                            race: entry.Race,
                            exp: entry.Exp,
                            age: entry.Age,
                            elo: eloValue,
                            x: xAxis === 'Date' ? entry.Date : (xAxis === 'Exp' ? entry.Exp : (xAxis === 'Age' ? entry.Age : entry.Race)),
                            y: eloValue
                        });
                    }
                });
                console.log('üìà Ladies\'s biathlon athlete', ladiesBiathlonAthleteMap[athleteId] + ':', validPoints, 'valid data points');
            });
            
            console.log('üéØ Total ladies\'s biathlon data points:', allData.length);
            
            // Group data by athlete for chart datasets
            const datasets = [];
            const colors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
            ];
            let colorIndex = 0;
            
            selectedAthleteIds.forEach(athleteId => {
                const athleteDataPoints = allData.filter(d => d.athleteId === athleteId);
                if (athleteDataPoints.length > 0) {
                    // Sort by x-axis value
                    athleteDataPoints.sort((a, b) => {
                        if (xAxis === 'Date') {
                            return new Date(a.date) - new Date(b.date);
                        } else if (xAxis === 'Exp') {
                            return a.exp - b.exp;
                        } else if (xAxis === 'Age') {
                            return a.age - b.age;
                        } else {
                            return a.race - b.race;
                        }
                    });
                    
                    // Apply data filtering if requested
                    let filteredPoints = athleteDataPoints;
                    if (filtering !== 'none') {
                        const step = parseInt(filtering);
                        filteredPoints = athleteDataPoints.filter((point, index) => index % step === 0);
                        console.log('üîΩ Filtered', ladiesBiathlonAthleteMap[athleteId], 'from', athleteDataPoints.length, 'to', filteredPoints.length, 'points');
                    }
                    
                    datasets.push({
                        label: ladiesBiathlonAthleteMap[athleteId],
                        data: filteredPoints.map(d => ({
                            x: xAxis === 'Date' ? new Date(d.date) : (xAxis === 'Exp' ? d.exp : (xAxis === 'Age' ? d.age : d.race)),
                            y: d.y
                        })),
                        borderColor: colors[colorIndex % colors.length],
                        backgroundColor: colors[colorIndex % colors.length] + '20',
                        fill: false,
                        tension: smoothing, // Use the selected smoothing value
                        pointRadius: filtering === 'none' ? 1 : 3, // Smaller points when showing all data
                        pointHoverRadius: 4,
                        borderWidth: 2
                    });
                    colorIndex++;
                }
            });
            
            console.log('üìä Created', datasets.length, 'ladies\'s biathlon chart datasets');
            
            // Destroy existing chart if it exists
            if (ladiesBiathlonChart) {
                console.log('üóëÔ∏è Destroying existing ladies\'s biathlon chart...');
                ladiesBiathlonChart.destroy();
                ladiesBiathlonChart = null;
            }
            
            // Get canvas and clear any existing Chart.js instances
            const canvas = document.getElementById('ladiesBiathlonChart');
            const existingChart = Chart.getChart(canvas);
            if (existingChart) {
                console.log('üóëÔ∏è Found existing Chart.js instance, destroying...');
                existingChart.destroy();
            }
            
            // Create new chart
            const ctx = canvas.getContext('2d');
            ladiesBiathlonChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: `Ladies Biathlon ${discipline} ${yAxis === 'Pct' ? 'Elo Percentage' : 'Elo Rating'} over ${xAxis === 'Exp' ? 'Career Experience' : xAxis}`
                        },
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        x: {
                            type: xAxis === 'Date' ? 'time' : 'linear',
                            time: xAxis === 'Date' ? {
                                unit: 'month',
                                tooltipFormat: 'MMM dd, yyyy',
                                displayFormats: {
                                    day: 'MMM dd',
                                    month: 'MMM yyyy',
                                    year: 'yyyy'
                                }
                            } : undefined,
                            title: {
                                display: true,
                                text: xAxis === 'Exp' ? 'Career Experience' : xAxis
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: yAxis === 'Pct' ? 'Elo Percentage' : 'Elo Rating'
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
            
            console.log('‚úÖ Ladies\'s biathlon chart created successfully!');
            
        } catch (error) {
            console.error('‚ùå Ladies\'s biathlon chart generation error:', error.message);
            console.error(error);
            alert('Error generating ladies biathlon chart. Please try again.');
        } finally {
            // Hide loading indicator
            document.getElementById('ladies-biathlon-loading-indicator').style.display = 'none';
        }
    }
    
    // Initialize the application when the DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üîÑ DOM loaded, starting ladies\'s biathlon initialization...');
        initializeLadiesBiathlonApp();
    });
    
    // Also try to initialize immediately in case DOM is already loaded
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeLadiesBiathlonApp);
    } else {
        // DOM is already loaded
        setTimeout(() => {
            console.log('üîÑ Page already loaded, starting ladies\'s biathlon initialization...');
            initializeLadiesBiathlonApp();
        }, 100);
    }
</script>