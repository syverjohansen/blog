{{/* layouts/biathlon/partials/radar.html */}}
<div class="card">
    <div class="card-header">
        <h4>Biathlon Performance Radar</h4>
    </div>
    <div class="card-body">
        <canvas id="biathlonRadarChart" width="400" height="400" style="width: 100%; height: auto;"></canvas>
        <div id="biathlon-radar-loading" class="text-center">
            <p>Waiting for athlete data...</p>
        </div>
        <div id="biathlon-radar-error" class="alert alert-danger" style="display:none;">
            <p id="biathlon-radar-error-message">Error loading radar chart data.</p>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Direct initialization function to avoid jQuery dependency
function initBiathlonRadarChart() {
    let biathlonRadarChart = null;
    
    // Function to calculate percentages if they don't exist
    function calculateBiathlonPercentages(data) {
        if (!data || data.length === 0) return data;
        
        // Clone the data to avoid modifying the original
        const processedData = JSON.parse(JSON.stringify(data));
        
        // See if the first entry already has percentage columns
        const firstEntry = processedData[0];
        const hasPercentages = firstEntry && firstEntry.hasOwnProperty('Elo_Pct');
        
        if (hasPercentages) {
            return processedData;
        }
        
        // Biathlon Elo columns to process
        const eloColumns = [
            "Elo", "Sprint_Elo", "Pursuit_Elo", "Individual_Elo", "MassStart_Elo"
        ];
        
        // Process each Elo column
        eloColumns.forEach(column => {
            if (!firstEntry || !firstEntry.hasOwnProperty(column)) {
                return;
            }
            
            // Get all values for this column
            const values = processedData.map(entry => parseFloat(entry[column]) || 0);
            
            // Find max value
            const maxValue = Math.max(...values);
            
            if (maxValue > 0) {
                // Calculate percentage for each entry
                processedData.forEach((entry, index) => {
                    const value = parseFloat(entry[column]) || 0;
                    entry[`${column}_Pct`] = Math.round((value / maxValue) * 100);
                });
            } else {
                // If no valid values, set all percentages to 0
                processedData.forEach(entry => {
                    entry[`${column}_Pct`] = 0;
                });
            }
        });
        
        return processedData;
    }
    
    // Function to create the radar chart with the data
    function createBiathlonRadarChart(data) {
        try {
            console.log('ðŸŽ¯ Creating biathlon radar chart with data:', data);
            
            // Hide loading message
            document.getElementById('biathlon-radar-loading').style.display = 'none';
            
            // Calculate percentages if needed
            const processedData = calculateBiathlonPercentages(data);
            console.log('ðŸŽ¯ Processed data for radar:', processedData);
            
            // Make sure we have data
            if (!processedData || processedData.length === 0) {
                console.error('ðŸŽ¯ No processed data available');
                document.getElementById('biathlon-radar-error').style.display = 'block';
                document.getElementById('biathlon-radar-error-message').textContent = 'Error: No data available for radar chart';
                return;
            }
            
            // Find the most recent entry
            const mostRecentEntry = processedData[processedData.length - 1];
            console.log('ðŸŽ¯ Most recent entry:', mostRecentEntry);
            
            // Check if percentage columns exist
            const hasPercentages = mostRecentEntry && mostRecentEntry.hasOwnProperty('Elo_Pct');
            console.log('ðŸŽ¯ Has percentage columns:', hasPercentages);
            
            if (!hasPercentages) {
                console.error('ðŸŽ¯ Percentage columns not available');
                document.getElementById('biathlon-radar-error').style.display = 'block';
                document.getElementById('biathlon-radar-error-message').textContent = 'Error: Percentage columns not available';
                return;
            }

            // Define all disciplines with their labels and data keys
            const allDisciplines = [
                { label: "Overall", key: "Elo_Pct" },
                { label: "Sprint", key: "Sprint_Elo_Pct" },
                { label: "Pursuit", key: "Pursuit_Elo_Pct" },
                { label: "Individual", key: "Individual_Elo_Pct" },
                { label: "Mass Start", key: "MassStart_Elo_Pct" }
            ];

            // Filter out disciplines with zero or missing values
            const activeDisciplines = allDisciplines.filter(d => {
                const value = parseFloat(mostRecentEntry[d.key]) || 0;
                return value > 0;
            });

            // Check if we have enough data points for a meaningful radar
            if (activeDisciplines.length < 3) {
                document.getElementById('biathlon-radar-error').style.display = 'block';
                document.getElementById('biathlon-radar-error-message').textContent = 'Not enough discipline data for radar chart (minimum 3 required)';
                return;
            }

            const radarLabels = activeDisciplines.map(d => d.label);
            const radarValues = activeDisciplines.map(d => parseFloat(mostRecentEntry[d.key]) || 0);

            const canvas = document.getElementById('biathlonRadarChart');
            if (!canvas) {
                document.getElementById('biathlon-radar-error').style.display = 'block';
                document.getElementById('biathlon-radar-error-message').textContent = 'Error: Canvas element not found';
                return;
            }
            
            const ctx = canvas.getContext('2d');
            if (!ctx) {
                document.getElementById('biathlon-radar-error').style.display = 'block';
                document.getElementById('biathlon-radar-error-message').textContent = 'Error: Canvas context not available';
                return;
            }
            
            if (biathlonRadarChart) {
                biathlonRadarChart.destroy();
            }
            
            biathlonRadarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: radarLabels,
                    datasets: [{
                        label: 'Most Recent Elo Percentiles',
                        data: radarValues,
                        backgroundColor: 'rgba(54, 162, 235, 0.2)', // Blue theme for biathlon
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(54, 162, 235, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(54, 162, 235, 1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        r: {
                            angleLines: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            pointLabels: {
                                font: {
                                    size: 12
                                }
                            },
                            suggestedMin: 0,
                            suggestedMax: 100,
                            ticks: {
                                callback: function(value) {
                                    return Math.round(value) + '%';
                                },
                                stepSize: 20
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        } catch (error) {
            document.getElementById('biathlon-radar-error').style.display = 'block';
            document.getElementById('biathlon-radar-error-message').textContent = 'Error creating chart: ' + error.message;
        }
    }
    
    // Listen for the skierDataLoaded event from the table component
    document.addEventListener('skierDataLoaded', function(e) {
        console.log('ðŸŽ¯ Biathlon radar: Received skierDataLoaded event');
        console.log('ðŸŽ¯ Event detail:', e.detail);
        
        if (e.detail && e.detail.skierData) {
            console.log('ðŸŽ¯ Processing skier data for radar chart...');
            console.log('ðŸŽ¯ Skier data length:', e.detail.skierData.length);
            createBiathlonRadarChart(e.detail.skierData);
        } else {
            console.error('ðŸŽ¯ Invalid data received from event:', e.detail);
            document.getElementById('biathlon-radar-error').style.display = 'block';
            document.getElementById('biathlon-radar-error-message').textContent = 'Error: Invalid data received from event';
        }
    });
}

// Initialize the radar chart when the DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    console.log('ðŸŽ¯ Biathlon radar chart DOM loaded, waiting for skier data...');
    initBiathlonRadarChart();
});

// Also add debugging to see if the event is being fired
document.addEventListener('skierDataLoaded', function(e) {
    console.log('ðŸŽ¯ Biathlon radar received skierDataLoaded event:', e.detail);
});
</script>