<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Men's Chart.js Data Visualization</title>
    <style>
        .container {
            margin: 20px;
        }

        #chart-container {
            width: 100%;
            height: 400px;
        }

        .skier-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 20px;
        }
        
        #loading-indicator {
            display: none;
            text-align: center;
            margin: 10px 0;
            font-style: italic;
        }
    </style>
</head>

<body>
    <!-- Men's ELO Chart Section -->
    <div class="container-fluid mt-4">
        <h2>Men's Elo Chart</h2>
        
        <!-- Controls -->
        <div class="row mb-3">
            <div class="col-md-6">
                <h4>Search Skiers</h4>
                <input type="text" id="search-box" class="form-control" placeholder="Search for skiers...">
                <div id="skier-menu" class="skier-menu mt-2" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px;">
                    <!-- Skier checkboxes will be populated here -->
                </div>
            </div>
            
            <div class="col-md-6">
                <h4>Chart Options</h4>
                
                <!-- X-Axis Options -->
                <div class="mb-2">
                    <label class="form-label">X-Axis:</label><br>
                    <input type="radio" name="x-axis" id="x-date" value="Date" checked>
                    <label for="x-date">Date</label><br>
                    <input type="radio" name="x-axis" id="x-exp" value="Exp">
                    <label for="x-exp">Career Experience</label><br>
                    <input type="radio" name="x-axis" id="x-age" value="Age">
                    <label for="x-age">Age</label>
                </div>
                
                <!-- Y-Axis Options -->
                <div class="mb-2">
                    <label class="form-label">Y-Axis:</label><br>
                    <input type="radio" name="y-axis" id="y-elo" value="Elo" checked>
                    <label for="y-elo">Elo Rating</label><br>
                    <input type="radio" name="y-axis" id="y-pct" value="Pct">
                    <label for="y-pct">Elo Percentage</label>
                </div>
                
                <!-- Discipline Options -->
                <div class="mb-2">
                    <label class="form-label">Discipline:</label><br>
                    <input type="radio" name="discipline" id="disc-overall" value="Overall" checked>
                    <label for="disc-overall">Overall</label><br>
                    <input type="radio" name="discipline" id="disc-downhill" value="Downhill">
                    <label for="disc-downhill">Downhill</label><br>
                    <input type="radio" name="discipline" id="disc-super-g" value="Super G">
                    <label for="disc-super-g">Super G</label><br>
                    <input type="radio" name="discipline" id="disc-giant-slalom" value="Giant Slalom">
                    <label for="disc-giant-slalom">Giant Slalom</label><br>
                    <input type="radio" name="discipline" id="disc-slalom" value="Slalom">
                    <label for="disc-slalom">Slalom</label><br>
                    <input type="radio" name="discipline" id="disc-combined" value="Combined">
                    <label for="disc-combined">Combined</label><br>
                    <input type="radio" name="discipline" id="disc-tech" value="Tech">
                    <label for="disc-tech">Technical</label><br>
                    <input type="radio" name="discipline" id="disc-speed" value="Speed">
                    <label for="disc-speed">Speed</label>
                </div>
                
                <!-- Smoothing Options -->
                <div class="mb-2">
                    <label class="form-label">Line Smoothing:</label><br>
                    <input type="radio" name="smoothing" id="smooth-low" value="0.1">
                    <label for="smooth-low">Sharp (0.1)</label><br>
                    <input type="radio" name="smoothing" id="smooth-medium" value="0.4" checked>
                    <label for="smooth-medium">Medium (0.4)</label><br>
                    <input type="radio" name="smoothing" id="smooth-high" value="0.7">
                    <label for="smooth-high">Smooth (0.7)</label><br>
                    <input type="radio" name="smoothing" id="smooth-very-high" value="1.0">
                    <label for="smooth-very-high">Very Smooth (1.0)</label>
                </div>
                
                <!-- Data Filtering Options -->
                <div class="mb-2">
                    <label class="form-label">Data Filtering:</label><br>
                    <input type="radio" name="filtering" id="filter-none" value="none" checked>
                    <label for="filter-none">All Points</label><br>
                    <input type="radio" name="filtering" id="filter-every-2" value="2">
                    <label for="filter-every-2">Every 2nd Point</label><br>
                    <input type="radio" name="filtering" id="filter-every-3" value="3">
                    <label for="filter-every-3">Every 3rd Point</label><br>
                    <input type="radio" name="filtering" id="filter-every-5" value="5">
                    <label for="filter-every-5">Every 5th Point</label>
                </div>
                
                <button id="generate-chart" class="btn btn-primary">Generate Chart</button>
            </div>
        </div>
        
        <!-- Loading Indicator -->
        <div id="loading-indicator" style="display: none; text-align: center; margin: 20px;">
            Loading skier data...
        </div>
        
        <!-- Chart Container -->
        <div id="chart-container">
            <canvas id="myChart"></canvas>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script>
        let myChart = null;
        const selectedSkiers = new Set();
        let skierMap = {}; // Store ID to name mapping
        let skierLookupData = []; // Store skier lookup data

        // Fetch skier IDs and names from M_all_ids.json
        fetch('/python/alpine/excel365/M_all_ids.json')
            .then(response => response.json())
            .then(data => {
                skierMap = Object.fromEntries(Object.entries(data)); // Create a map of skier ID to name

                const skierMenu = document.getElementById('skier-menu');
                const searchBox = document.getElementById('search-box');
                const generateChartButton = document.getElementById('generate-chart');

                const skierData = Object.entries(data);

                const renderSkiers = (filter = "") => {
                    skierMenu.innerHTML = "";
                    const selected = skierData.filter(([id]) => selectedSkiers.has(id));
                    const unselected = skierData.filter(([id, name]) => !selectedSkiers.has(id) && name.toLowerCase().includes(filter.toLowerCase()));

                    // Render selected skiers first
                    selected.forEach(([id, name]) => {
                        const label = document.createElement('label');
                        label.style.display = 'block';
                        label.innerHTML = `<input type="checkbox" class="skier-checkbox" value="${id}" checked> ${name}`;
                        skierMenu.appendChild(label);
                    });

                    // Render filtered unselected skiers
                    unselected.forEach(([id, name]) => {
                        const label = document.createElement('label');
                        label.style.display = 'block';
                        label.innerHTML = `<input type="checkbox" class="skier-checkbox" value="${id}"> ${name}`;
                        skierMenu.appendChild(label);
                    });
                };

                // Initial render with all skiers
                renderSkiers();

                searchBox.addEventListener('input', (event) => {
                    renderSkiers(event.target.value);
                });

                skierMenu.addEventListener('change', (event) => {
                    if (event.target.classList.contains('skier-checkbox')) {
                        const skierId = event.target.value;
                        if (event.target.checked) {
                            selectedSkiers.add(skierId);
                        } else {
                            selectedSkiers.delete(skierId);
                        }
                    }
                });

                generateChartButton.addEventListener('click', () => {
                    generateChart();
                });
                
                // Also fetch skier lookup data for grouping info
                return fetch('/python/alpine/excel365/M_skiers_lookup.json');
            })
            .then(response => response.json())
            .then(lookupData => {
                skierLookupData = lookupData;
            })
            .catch(error => console.error('Error loading skier data:', error));

        // Function to load data for a skier from the grouped files
        async function fetchSkierData(skierId) {
            // Find skier in lookup data to get the group
            const skierInfo = skierLookupData.find(s => s.id === parseInt(skierId));
            
            if (!skierInfo) {
                console.error(`Skier with ID ${skierId} not found in lookup data`);
                return null;
            }
            
            // Use the group name directly for the filename
            const groupFileName = skierInfo.group;
            
            // Fetch group data
            try {
                const response = await fetch(`/python/alpine/excel365/M/skiers_${groupFileName}.json`);
                if (!response.ok) {
                    throw new Error(`Failed to fetch group data: ${response.status}`);
                }
                
                const groupData = await response.json();
                
                // Extract this skier's data
                const skierData = groupData[skierId];
                
                if (!skierData) {
                    console.error(`No data found for skier ID ${skierId} in group data`);
                    return null;
                }
                
                // Transform data into array of objects
                const result = [];
                const keys = Object.keys(skierData);
                const rowCount = skierData[keys[0]].length;
                
                for (let i = 0; i < rowCount; i++) {
                    const rowObj = {};
                    keys.forEach(key => {
                        rowObj[key] = skierData[key][i];
                    });
                    result.push(rowObj);
                }
                
                return result;
            } catch (error) {
                console.error(`Error fetching data for skier ${skierId}:`, error);
                return null;
            }
        }

        async function generateChart() {
            const selectedSkiers = Array.from(document.querySelectorAll('.skier-checkbox:checked')).map(cb => cb.value);
            if (selectedSkiers.length === 0) {
                alert('Please select at least one skier');
                return;
            }
            
            const xAxis = document.querySelector('input[name="x-axis"]:checked').value;
            const yAxis = document.querySelector('input[name="y-axis"]:checked').value;
            const discipline = document.querySelector('input[name="discipline"]:checked').value;
            const smoothing = parseFloat(document.querySelector('input[name="smoothing"]:checked').value);
            const filtering = document.querySelector('input[name="filtering"]:checked').value;

            // Show loading indicator
            document.getElementById('loading-indicator').style.display = 'block';

            // Determine the correct Elo field based on selected discipline
            let eloField;
            if (discipline === "Overall") {
                eloField = "Elo";
            } else if (discipline === "Downhill") {
                eloField = "Downhill_Elo";
            } else if (discipline === "Super G") {
                eloField = "Super G_Elo";
            } else if (discipline === "Giant Slalom") {
                eloField = "Giant Slalom_Elo";
            } else if (discipline === "Slalom") {
                eloField = "Slalom_Elo";
            } else if (discipline === "Combined") {
                eloField = "Combined_Elo";
            } else if (discipline === "Tech") {
                eloField = "Tech_Elo";
            } else if (discipline === "Speed") {
                eloField = "Speed_Elo";
            }

            try {
                // Fetch data for each selected skier
                const skiersData = await Promise.all(selectedSkiers.map(fetchSkierData));
                
                // Process the data
                const allData = [];
                skiersData.forEach((skierData, index) => {
                    if (!skierData) return;
                    
                    const skierId = selectedSkiers[index];
                    skierData.forEach(entry => {
                        const isPct = (yAxis === 'Pct');
                        const eloValue = isPct ? (entry[`${eloField}_Pct`] ?? null) : entry[eloField];
                        
                        if (eloValue !== null && eloValue !== undefined) {
                            allData.push({
                                skierId: skierId,
                                skierName: skierMap[skierId],
                                date: entry.Date,
                                race: entry.Race,
                                exp: entry.Exp,
                                age: entry.Age,
                                elo: eloValue,
                                x: xAxis === 'Date' ? entry.Date : (xAxis === 'Exp' ? entry.Exp : (xAxis === 'Race' ? entry.Race : entry.Age)),
                                y: eloValue
                            });
                        }
                    });
                });

                // Group data by skier for chart datasets
                const datasets = [];
                const colors = [
                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                    '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
                ];
                let colorIndex = 0;
                
                selectedSkiers.forEach(skierId => {
                    const skierDataPoints = allData.filter(d => d.skierId === skierId);
                    if (skierDataPoints.length > 0) {
                        // Sort by x-axis value
                        skierDataPoints.sort((a, b) => {
                            if (xAxis === 'Date') {
                                return new Date(a.date) - new Date(b.date);
                            } else if (xAxis === 'Exp') {
                                return a.exp - b.exp;
                            } else if (xAxis === 'Race') {
                                return a.race - b.race;
                            } else {
                                return a.age - b.age;
                            }
                        });
                        
                        // Apply data filtering if requested
                        let filteredPoints = skierDataPoints;
                        if (filtering !== 'none') {
                            const step = parseInt(filtering);
                            filteredPoints = skierDataPoints.filter((point, index) => index % step === 0);
                        }
                        
                        datasets.push({
                            label: skierMap[skierId],
                            data: filteredPoints.map(d => ({
                                x: xAxis === 'Date' ? new Date(d.date) : (xAxis === 'Exp' ? d.exp : (xAxis === 'Race' ? d.race : d.age)),
                                y: d.y
                            })),
                            borderColor: colors[colorIndex % colors.length],
                            backgroundColor: colors[colorIndex % colors.length] + '20',
                            fill: false,
                            tension: smoothing,
                            pointRadius: filtering === 'none' ? 1 : 3,
                            pointHoverRadius: 4,
                            borderWidth: 2
                        });
                        colorIndex++;
                    }
                });

                // Destroy existing chart if it exists
                if (myChart) {
                    myChart.destroy();
                }

                // Get canvas and clear any existing Chart.js instances
                const canvas = document.getElementById('myChart');
                const existingChart = Chart.getChart(canvas);
                if (existingChart) {
                    existingChart.destroy();
                }

                // Create new chart
                const ctx = canvas.getContext('2d');
                myChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: `Men's ${discipline} ${yAxis === 'Pct' ? 'Elo Percentage' : 'Elo Rating'} over ${xAxis === 'Exp' ? 'Career Experience' : xAxis}`
                            },
                            legend: {
                                display: true
                            }
                        },
                        scales: {
                            x: {
                                type: xAxis === 'Date' ? 'time' : 'linear',
                                time: xAxis === 'Date' ? {
                                    unit: 'month',
                                    tooltipFormat: 'MMM dd, yyyy',
                                    displayFormats: {
                                        day: 'MMM dd',
                                        month: 'MMM yyyy',
                                        year: 'yyyy'
                                    }
                                } : undefined,
                                title: {
                                    display: true,
                                    text: xAxis === 'Exp' ? 'Career Experience' : xAxis
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: yAxis === 'Pct' ? 'Elo Percentage' : 'Elo Rating'
                                }
                            }
                        },
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        }
                    }
                });
            } catch (error) {
                console.error('Error generating chart:', error);
                alert('Error generating chart. Please try again.');
            } finally {
                document.getElementById('loading-indicator').style.display = 'none';
            }
        }
    </script>

</body>

</html>