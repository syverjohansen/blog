{{/* layouts/alpine/partials/skier-table.html */}}
<style>
    .bbref-table-wrapper {
        position: relative; width: 100%; margin: 1rem 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        font-size: 14px;
    }
    .bbref-table-container {
        width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch;
        border: 1px solid #ccc; border-radius: 4px; max-height: 500px; overflow-y: auto;
    }
    .bbref-table-container::-webkit-scrollbar { height: 8px; width: 8px; }
    .bbref-table-container::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
    .bbref-table-container::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
    .scroll-indicator-left, .scroll-indicator-right {
        position: absolute; top: 0; bottom: 0; width: 20px;
        pointer-events: none; opacity: 0; transition: opacity 0.2s; z-index: 5;
    }
    .scroll-indicator-left { left: 0; background: linear-gradient(to right, rgba(0,0,0,0.08), transparent); }
    .scroll-indicator-right { right: 0; background: linear-gradient(to left, rgba(0,0,0,0.08), transparent); }
    .scroll-indicator-left.active, .scroll-indicator-right.active { opacity: 1; }
    .bbref-table {
        width: 100%; min-width: max-content;
        border-collapse: separate; border-spacing: 0; background: white;
    }
    .bbref-table th, .bbref-table td {
        padding: 6px 10px; text-align: left; white-space: nowrap; border-bottom: 1px solid #ddd;
    }
    .bbref-table th {
        background: linear-gradient(to bottom, #f8f9fa, #e9ecef);
        font-weight: 600; color: #333; border-bottom: 2px solid #ccc;
        position: sticky; top: 0; z-index: 2; cursor: pointer; user-select: none;
    }
    .bbref-table th:hover { background: linear-gradient(to bottom, #e9ecef, #dee2e6); }
    .bbref-table th.sort-asc::after { content: ' \25B2'; font-size: 10px; }
    .bbref-table th.sort-desc::after { content: ' \25BC'; font-size: 10px; }
    .bbref-table .sticky-col { position: sticky; left: 0; z-index: 3; background: white; border-right: 2px solid #ccc; }
    .bbref-table .sticky-col-2 { position: sticky; left: 80px; z-index: 3; background: white; border-right: 2px solid #ccc; }
    .bbref-table th.sticky-col, .bbref-table th.sticky-col-2 { z-index: 4; background: linear-gradient(to bottom, #f8f9fa, #e9ecef); }
    .bbref-table tbody tr:nth-child(odd) { background-color: #f8f9fa; }
    .bbref-table tbody tr:nth-child(odd) .sticky-col, .bbref-table tbody tr:nth-child(odd) .sticky-col-2 { background-color: #f8f9fa; }
    .bbref-table tbody tr:hover { background-color: #e8f4fc !important; }
    .bbref-table tbody tr:hover .sticky-col, .bbref-table tbody tr:hover .sticky-col-2 { background-color: #e8f4fc !important; }
    .bbref-table td.numeric { text-align: right; font-variant-numeric: tabular-nums; }
    .mode-toggle { margin-bottom: 1rem; }
    .mode-toggle .btn { padding: 8px 16px; border: 1px solid #ccc; background: #fff; cursor: pointer; font-size: 14px; }
    .mode-toggle .btn.active { background: #0066cc; color: white; border-color: #0066cc; }
    .mode-toggle .btn:first-child { border-radius: 4px 0 0 4px; }
    .mode-toggle .btn:last-child { border-radius: 0 4px 4px 0; }
    #loading-indicator { text-align: center; padding: 20px; color: #666; }
    @media (max-width: 600px) {
        .bbref-table-wrapper { font-size: 13px; }
        .bbref-table th, .bbref-table td { padding: 5px 8px; }
        /* Hide Country (3), Season (8), Race (9) columns on mobile */
        .bbref-table th:nth-child(3),
        .bbref-table td:nth-child(3),
        .bbref-table th:nth-child(8),
        .bbref-table td:nth-child(8),
        .bbref-table th:nth-child(9),
        .bbref-table td:nth-child(9) {
            display: none;
        }
        /* Remove sticky from City column on mobile */
        .bbref-table .sticky-col-2 {
            position: static;
            border-right: none;
        }
        /* Keep only Date column sticky */
        .bbref-table .sticky-col {
            position: sticky;
            left: 0;
        }
    }
</style>

<div id="toggle-buttons" class="mode-toggle">
    <button id="elo-mode-btn" class="btn active">Elo Mode</button>
    <button id="percent-mode-btn" class="btn">Percent of Max Mode</button>
</div>

<div id="loading-indicator">
    <p>Loading skier data...</p>
</div>

<div class="bbref-table-wrapper" id="wrapper-skier" style="display: none;">
    <div class="scroll-indicator-left"></div>
    <div class="scroll-indicator-right active"></div>
    <div class="bbref-table-container">
        <table id="dataTableL" class="bbref-table">
            <thead></thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const sex = urlParams.get('gender')?.toUpperCase();
    const id = urlParams.get('id');

    let skierData = null;
    const wrapper = document.getElementById('wrapper-skier');
    const container = wrapper.querySelector('.bbref-table-container');
    const table = document.getElementById('dataTableL');

    const eloColumns = ['Date', 'City', 'Country', 'Distance', 'MS', 'Technique', 'Place', 'Season', 'Race', 'Age',
        'Elo', 'Distance_Elo', 'Distance_C_Elo', 'Distance_F_Elo', 'Sprint_Elo', 'Sprint_C_Elo', 'Sprint_F_Elo',
        'Classic_Elo', 'Freestyle_Elo'];

    const pctColumns = ['Date', 'City', 'Country', 'Distance', 'MS', 'Technique', 'Place', 'Season', 'Race', 'Age',
        'Elo_Pct', 'Distance_Elo_Pct', 'Distance_C_Elo_Pct', 'Distance_F_Elo_Pct', 'Sprint_Elo_Pct',
        'Sprint_C_Elo_Pct', 'Sprint_F_Elo_Pct', 'Classic_Elo_Pct', 'Freestyle_Elo_Pct'];

    const titleMap = {
        'Distance_Elo': 'Distance', 'Distance_C_Elo': 'Distance Classic', 'Distance_F_Elo': 'Distance Freestyle',
        'Sprint_Elo': 'Sprint', 'Sprint_C_Elo': 'Sprint Classic', 'Sprint_F_Elo': 'Sprint Freestyle',
        'Classic_Elo': 'Classic', 'Freestyle_Elo': 'Freestyle',
        'Elo_Pct': 'Overall %', 'Distance_Elo_Pct': 'Distance %', 'Distance_C_Elo_Pct': 'Distance Classic %',
        'Distance_F_Elo_Pct': 'Distance Freestyle %', 'Sprint_Elo_Pct': 'Sprint %',
        'Sprint_C_Elo_Pct': 'Sprint Classic %', 'Sprint_F_Elo_Pct': 'Sprint Freestyle %',
        'Classic_Elo_Pct': 'Classic %', 'Freestyle_Elo_Pct': 'Freestyle %'
    };

    function formatSkierData(groupData, id) {
        const rawData = groupData[id];
        if (!rawData) return [];

        const dataArray = [];
        const keys = Object.keys(rawData);
        const rowCount = rawData[keys[0]].length;

        // Calculate percentage columns if they don't exist
        const eloKeys = keys.filter(key => key.includes('Elo') && !key.includes('_Pct'));
        eloKeys.forEach(eloKey => {
            const pctKey = `${eloKey}_Pct`;
            if (!rawData[pctKey]) {
                const eloValues = rawData[eloKey];
                const maxElo = Math.max(...eloValues.map(val => parseFloat(val) || 0));
                rawData[pctKey] = maxElo > 0 ? eloValues.map(val => ((parseFloat(val) || 0) / maxElo * 100).toFixed(2)) : Array(eloValues.length).fill(0);
            }
        });

        for (let i = 0; i < rowCount; i++) {
            const rowObj = {};
            Object.keys(rawData).forEach(key => { rowObj[key] = rawData[key][i]; });
            dataArray.push(rowObj);
        }
        return dataArray;
    }

    function renderTable(data, columnsToShow) {
        if (!data || data.length === 0) return;

        const availableColumns = Object.keys(data[0]);
        columnsToShow = columnsToShow.filter(col => availableColumns.includes(col));

        let sortCol = 0;
        let sortDir = 'desc';

        const thead = table.querySelector('thead');
        let headerRow = '<tr>';
        columnsToShow.forEach((col, idx) => {
            const title = titleMap[col] || col.replace(/_/g, ' ');
            const stickyClass = idx === 0 ? 'sticky-col' : (idx === 1 ? 'sticky-col-2' : '');
            headerRow += `<th class="${stickyClass}" data-col="${col}" data-idx="${idx}">${title}</th>`;
        });
        headerRow += '</tr>';
        thead.innerHTML = headerRow;

        let sortedData = [...data];

        function buildRows() {
            const tbody = table.querySelector('tbody');
            tbody.innerHTML = '';

            sortedData.forEach(row => {
                let tr = '<tr>';
                columnsToShow.forEach((col, idx) => {
                    const val = row[col];
                    const stickyClass = idx === 0 ? 'sticky-col' : (idx === 1 ? 'sticky-col-2' : '');
                    const numericClass = (col.includes('Elo') || col === 'Age' || col === 'Place') ? 'numeric' : '';

                    if (col.includes('_Pct')) {
                        tr += `<td class="${stickyClass} ${numericClass}">${val ? Math.round(parseFloat(val)) + '%' : ''}</td>`;
                    } else if (col.includes('Elo') || col === 'Age') {
                        tr += `<td class="${stickyClass} ${numericClass}">${val ? Math.round(parseFloat(val)) : ''}</td>`;
                    } else {
                        tr += `<td class="${stickyClass} ${numericClass}">${val || ''}</td>`;
                    }
                });
                tr += '</tr>';
                tbody.innerHTML += tr;
            });

            updateScrollIndicators();
        }

        function updateScrollIndicators() {
            const left = wrapper.querySelector('.scroll-indicator-left');
            const right = wrapper.querySelector('.scroll-indicator-right');
            left.classList.toggle('active', container.scrollLeft > 5);
            right.classList.toggle('active', container.scrollLeft < container.scrollWidth - container.clientWidth - 5);
        }

        container.addEventListener('scroll', updateScrollIndicators);

        thead.querySelectorAll('th').forEach(th => {
            th.addEventListener('click', () => {
                const colKey = th.dataset.col;
                const colIdx = parseInt(th.dataset.idx);

                if (sortCol === colIdx) {
                    sortDir = sortDir === 'desc' ? 'asc' : 'desc';
                } else {
                    sortCol = colIdx;
                    sortDir = colKey === 'Date' || colKey.includes('Elo') ? 'desc' : 'asc';
                }

                thead.querySelectorAll('th').forEach(h => h.classList.remove('sort-asc', 'sort-desc'));
                th.classList.add('sort-' + sortDir);

                sortedData.sort((a, b) => {
                    let aVal = a[colKey], bVal = b[colKey];
                    if (colKey === 'Date') {
                        aVal = aVal ? new Date(aVal) : new Date(0);
                        bVal = bVal ? new Date(bVal) : new Date(0);
                    }
                    let result;
                    if (typeof aVal === 'number' && typeof bVal === 'number') {
                        result = aVal - bVal;
                    } else if (aVal instanceof Date) {
                        result = aVal - bVal;
                    } else {
                        result = String(aVal || '').localeCompare(String(bVal || ''));
                    }
                    return sortDir === 'desc' ? -result : result;
                });

                buildRows();
            });
        });

        // Initial sort by date descending
        sortedData.sort((a, b) => new Date(b.Date || 0) - new Date(a.Date || 0));
        buildRows();
    }

    async function fetchSkierGroup(sex, id) {
        const lookupUrl = `/python/alpine/excel365/${sex}_skiers_lookup.json`;
        try {
            const response = await fetch(lookupUrl);
            const skiersList = await response.json();
            const skierInfo = skiersList.find(skier => skier.id === parseInt(id));
            return skierInfo ? skierInfo.group : null;
        } catch (error) {
            return null;
        }
    }

    async function fetchSkierData(sex, id) {
        try {
            const group = await fetchSkierGroup(sex, id);
            if (!group) throw new Error('Could not determine skier group');

            const groupUrl = `/python/alpine/excel365/${sex}/skiers_${group}.json`;
            const response = await fetch(groupUrl);
            const groupData = await response.json();

            skierData = formatSkierData(groupData, id);

            document.getElementById('loading-indicator').style.display = 'none';
            wrapper.style.display = 'block';

            renderTable(skierData, eloColumns);

            document.dispatchEvent(new CustomEvent('skierDataLoaded', {
                detail: { skierData, sex, id }
            }));
        } catch (error) {
            document.getElementById('loading-indicator').innerHTML = '<p>Error loading skier data. Please try again later.</p>';
        }
    }

    if (sex && id) {
        fetchSkierData(sex, id);
    } else {
        document.getElementById('loading-indicator').innerHTML = '<p>Missing gender or ID parameters</p>';
    }

    document.getElementById('elo-mode-btn').addEventListener('click', function() {
        this.classList.add('active');
        document.getElementById('percent-mode-btn').classList.remove('active');
        if (skierData) renderTable(skierData, eloColumns);
    });

    document.getElementById('percent-mode-btn').addEventListener('click', function() {
        this.classList.add('active');
        document.getElementById('elo-mode-btn').classList.remove('active');
        if (skierData) renderTable(skierData, pctColumns);
    });
});
</script>
