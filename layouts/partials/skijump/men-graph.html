<!-- Men's ELO Chart Section -->
<div class="container-fluid mt-4">
    <h2>Men's Elo Chart</h2>
    
    <!-- Controls -->
    <div class="row mb-3">
        <div class="col-md-6">
            <h4>Search Skiers</h4>
            <input type="text" id="search-box" class="form-control" placeholder="Search for skiers...">
            <div id="skier-menu" class="skier-menu mt-2" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px;">
                <!-- Skier checkboxes will be populated here -->
            </div>
        </div>
        
        <div class="col-md-6">
            <h4>Chart Options</h4>
            
            <!-- X-Axis Options -->
            <div class="mb-2">
                <label class="form-label">X-Axis:</label><br>
                <input type="radio" name="x-axis" id="x-date" value="Date" checked>
                <label for="x-date">Date</label><br>
                <input type="radio" name="x-axis" id="x-exp" value="Exp">
                <label for="x-exp">Career Experience</label><br>
                <input type="radio" name="x-axis" id="x-age" value="Age">
                <label for="x-age">Age</label>
            </div>
            
            <!-- Y-Axis Options -->
            <div class="mb-2">
                <label class="form-label">Y-Axis:</label><br>
                <input type="radio" name="y-axis" id="y-elo" value="Elo" checked>
                <label for="y-elo">Elo Rating</label><br>
                <input type="radio" name="y-axis" id="y-pct" value="Pct">
                <label for="y-pct">Elo Percentage</label>
            </div>
            
            <!-- Hill Size Selection -->
            <div class="mb-2">
                <label class="form-label">Hill Size:</label><br>
                <input type="radio" name="hill-size" id="hill-overall" value="Overall" checked>
                <label for="hill-overall">Overall</label><br>
                <input type="radio" name="hill-size" id="hill-small" value="Small">
                <label for="hill-small">Small Hill</label><br>
                <input type="radio" name="hill-size" id="hill-medium" value="Medium">
                <label for="hill-medium">Medium Hill</label><br>
                <input type="radio" name="hill-size" id="hill-normal" value="Normal">
                <label for="hill-normal">Normal Hill</label><br>
                <input type="radio" name="hill-size" id="hill-large" value="Large">
                <label for="hill-large">Large Hill</label><br>
                <input type="radio" name="hill-size" id="hill-flying" value="Flying">
                <label for="hill-flying">Flying Hill</label>
            </div>
            
            <!-- Smoothing Options -->
            <div class="mb-2">
                <label class="form-label">Line Smoothing:</label><br>
                <input type="radio" name="smoothing" id="smooth-low" value="0.1">
                <label for="smooth-low">Sharp (0.1)</label><br>
                <input type="radio" name="smoothing" id="smooth-medium" value="0.4" checked>
                <label for="smooth-medium">Medium (0.4)</label><br>
                <input type="radio" name="smoothing" id="smooth-high" value="0.7">
                <label for="smooth-high">Smooth (0.7)</label><br>
                <input type="radio" name="smoothing" id="smooth-very-high" value="1.0">
                <label for="smooth-very-high">Very Smooth (1.0)</label>
            </div>
            
            <!-- Data Filtering Options -->
            <div class="mb-2">
                <label class="form-label">Data Filtering:</label><br>
                <input type="radio" name="filtering" id="filter-none" value="none" checked>
                <label for="filter-none">All Points</label><br>
                <input type="radio" name="filtering" id="filter-every-2" value="2">
                <label for="filter-every-2">Every 2nd Point</label><br>
                <input type="radio" name="filtering" id="filter-every-3" value="3">
                <label for="filter-every-3">Every 3rd Point</label><br>
                <input type="radio" name="filtering" id="filter-every-5" value="5">
                <label for="filter-every-5">Every 5th Point</label>
            </div>
            
            <button id="generate-chart" class="btn btn-primary">Generate Chart</button>
        </div>
    </div>
    
    <!-- Loading Indicator -->
    <div id="loading-indicator" style="display: none; text-align: center; margin: 20px;">
        Loading skier data...
    </div>
    
    <!-- Chart Container -->
    <div id="chart-container">
        <canvas id="myChart"></canvas>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script>
    let menChart = null;
    const selectedMenSkiers = new Set();
    let menSkierMap = {}; // Store ID to name mapping
    let menSkierLookupData = []; // Store skier lookup data

    // Get base path from Hugo
    const menBasePath = '{{ "python/skijump/excel365/" | relURL }}';
    
    // Initialize the application
    async function initializeMenApp() {
        try {
            console.log('🔄 Starting men\'s initialization...', new Date().toLocaleTimeString());
            console.log('📂 Men\'s base path:', menBasePath);
            console.log('🌐 Current URL:', window.location.href);
            
            // Fetch skier IDs and names from M_all_ids.json
            const idsUrl = menBasePath + 'M_all_ids.json';
            console.log('📥 Attempting to fetch men\'s IDs from:', idsUrl);
            
            const idsResponse = await fetch(idsUrl);
            console.log('📊 Men\'s IDs response status:', idsResponse.status, idsResponse.statusText);
            
            if (!idsResponse.ok) {
                console.error('❌ Failed to fetch men\'s IDs. Response headers:', [...idsResponse.headers]);
                throw new Error(`Failed to fetch IDs: ${idsResponse.status} ${idsResponse.statusText}`);
            }
            
            const idsData = await idsResponse.json();
            const idsCount = Object.keys(idsData).length;
            console.log('👥 Successfully loaded', idsCount, 'men skiers from IDs file');
            
            if (idsCount > 0) {
                const firstThree = Object.entries(idsData).slice(0, 3);
                console.log('🏂 First few men skiers:', firstThree.map(([id, name]) => `ID: ${id} (${typeof id}) → Name: "${name}"`));
            }
            
            menSkierMap = Object.fromEntries(Object.entries(idsData));
            
            // Fetch skier lookup data for grouping info
            const lookupUrl = menBasePath + 'M_skiers_lookup.json';
            console.log('📥 Attempting to fetch men\'s lookup data from:', lookupUrl);
            
            const lookupResponse = await fetch(lookupUrl);
            console.log('📊 Men\'s lookup response status:', lookupResponse.status, lookupResponse.statusText);
            
            if (!lookupResponse.ok) {
                console.error('❌ Failed to fetch men\'s lookup data');
                throw new Error(`Failed to fetch lookup data: ${lookupResponse.status} ${lookupResponse.statusText}`);
            }
            
            const lookupData = await lookupResponse.json();
            console.log('🔍 Successfully loaded', lookupData.length, 'entries from men\'s lookup data');
            
            // Show some sample lookup entries
            if (lookupData.length > 0) {
                const sampleLookup = lookupData.slice(0, 3);
                console.log('📋 Sample men\'s lookup entries:', sampleLookup.map(entry => 
                    `ID: ${entry.id} (${typeof entry.id}) → Skier: "${entry.skier}" → Group: "${entry.group}"`
                ));
            }
            
            menSkierLookupData = lookupData;
            
            // Set up UI elements
            console.log('🎨 Setting up men\'s UI elements...');
            setupMenUI(idsData);
            
            console.log('✅ Men\'s initialization completed successfully at', new Date().toLocaleTimeString());
            
        } catch (error) {
            console.error('❌ MEN\'S INITIALIZATION ERROR:', error.message);
            console.error('Stack trace:', error.stack);
            alert(`Error loading men's skier data: ${error.message}`);
        }
    }
    
    function setupMenUI(idsData) {
        const skierMenu = document.getElementById('skier-menu');
        const searchBox = document.getElementById('search-box');
        const generateChartButton = document.getElementById('generate-chart');
        
        const skierData = Object.entries(idsData);
        
        const renderSkiers = (filter = "") => {
            skierMenu.innerHTML = "";
            const selected = skierData.filter(([id]) => selectedMenSkiers.has(id));
            const unselected = skierData.filter(([id, name]) => 
                !selectedMenSkiers.has(id) && 
                name.toLowerCase().includes(filter.toLowerCase())
            );
            
            // Render selected skiers first
            selected.forEach(([id, name]) => {
                const label = document.createElement('label');
                label.style.display = 'block';
                label.innerHTML = `<input type="checkbox" class="skier-checkbox" value="${id}" checked> ${name}`;
                skierMenu.appendChild(label);
            });
            
            // Render filtered unselected skiers
            unselected.forEach(([id, name]) => {
                const label = document.createElement('label');
                label.style.display = 'block';
                label.innerHTML = `<input type="checkbox" class="skier-checkbox" value="${id}"> ${name}`;
                skierMenu.appendChild(label);
            });
        };
        
        // Initial render with all skiers
        renderSkiers();
        
        // Set up event listeners
        searchBox.addEventListener('input', (event) => {
            renderSkiers(event.target.value);
        });
        
        skierMenu.addEventListener('change', (event) => {
            if (event.target.classList.contains('skier-checkbox')) {
                const skierId = event.target.value;
                if (event.target.checked) {
                    selectedMenSkiers.add(skierId);
                } else {
                    selectedMenSkiers.delete(skierId);
                }
            }
        });
        
        generateChartButton.addEventListener('click', () => {
            generateMenChart();
        });
    }
    
    // Function to load data for a skier from the grouped files
    async function fetchMenSkierData(skierId) {
        // Find skier in lookup data to get the group
        const skierInfo = menSkierLookupData.find(s => s.id === parseInt(skierId));
        
        if (!skierInfo) {
            console.error('❌ Men\'s skier with ID', skierId, 'not found in lookup data');
            return null;
        }
        
        console.log('🎿 Processing men\'s skier:', skierInfo.skier, '(ID:', skierId, ', Group:', skierInfo.group + ')');
        
        // Use the group name directly for the filename
        const groupFileName = skierInfo.group;
        const fileUrl = `${menBasePath}M/skiers_${groupFileName}.json`;
        
        console.log('📂 Fetching men\'s data from:', fileUrl);
        
        // Fetch group data using the base path
        try {
            const response = await fetch(fileUrl);
            console.log('📊 Men\'s file response status:', response.status);
            
            if (!response.ok) {
                console.error('❌ Failed to fetch men\'s group data:', response.status);
                throw new Error(`Failed to fetch group data: ${response.status}`);
            }
            
            const groupData = await response.json();
            console.log('📁 Men\'s group file contains', Object.keys(groupData).length, 'skiers');
            
            // Extract this skier's data
            const skierData = groupData[skierId];
            
            if (!skierData) {
                console.error('❌ No data found for men\'s skier ID', skierId, 'in group data');
                console.log('🔍 Available skier IDs in this group:', Object.keys(groupData).slice(0, 10));
                return null;
            }
            
            // Transform data into array of objects
            const result = [];
            const keys = Object.keys(skierData);
            const rowCount = skierData[keys[0]].length;
            
            console.log('📈 Found', rowCount, 'data points for men\'s', skierInfo.skier);
            
            for (let i = 0; i < rowCount; i++) {
                const rowObj = {};
                keys.forEach(key => {
                    rowObj[key] = skierData[key][i];
                });
                result.push(rowObj);
            }
            
            console.log('✅ Successfully processed data for men\'s', skierInfo.skier);
            return result;
        } catch (error) {
            console.error('❌ Error fetching data for men\'s skier', skierId + ':', error.message);
            return null;
        }
    }
    
    async function generateMenChart() {
        console.log('🚀 Starting men\'s chart generation...');
        
        const selectedSkierIds = Array.from(document.querySelectorAll('.skier-checkbox:checked')).map(cb => cb.value);
        console.log('👥 Selected', selectedSkierIds.length, 'men skiers:', selectedSkierIds);
        
        if (selectedSkierIds.length === 0) {
            alert('Please select at least one skier');
            return;
        }
        
        const xAxis = document.querySelector('input[name="x-axis"]:checked').value;
        const yAxis = document.querySelector('input[name="y-axis"]:checked').value;
        const hillSize = document.querySelector('input[name="hill-size"]:checked').value;
        const smoothing = parseFloat(document.querySelector('input[name="smoothing"]:checked').value);
        const filtering = document.querySelector('input[name="filtering"]:checked').value;
        
        console.log('⚙️ Men\'s chart settings - X:', xAxis, ', Y:', yAxis, ', Hill:', hillSize, ', Smoothing:', smoothing, ', Filtering:', filtering);
        
        // Show loading indicator
        document.getElementById('loading-indicator').style.display = 'block';
        
        // Determine the correct Elo field based on selected hill size
        let eloField;
        if (hillSize === "Overall") {
            eloField = "Elo";
        } else if (hillSize === "Small") {
            eloField = "Small_Elo";
        } else if (hillSize === "Medium") {
            eloField = "Medium_Elo";
        } else if (hillSize === "Normal") {
            eloField = "Normal_Elo";
        } else if (hillSize === "Large") {
            eloField = "Large_Elo";
        } else if (hillSize === "Flying") {
            eloField = "Flying_Elo";
        }
        
        console.log('📊 Using men\'s Elo field:', eloField);
        
        try {
            // Fetch data for each selected skier
            console.log('📥 Fetching data for selected men skiers...');
            const skiersData = await Promise.all(selectedSkierIds.map(fetchMenSkierData));
            
            console.log('✅ Men\'s data fetch complete. Processing results...');
            
            // Process the data
            const allData = [];
            skiersData.forEach((skierData, index) => {
                if (!skierData) {
                    console.warn('⚠️ No data for men\'s skier', selectedSkierIds[index]);
                    return;
                }
                
                const skierId = selectedSkierIds[index];
                let validPoints = 0;
                skierData.forEach(entry => {
                    const isPct = (yAxis === 'Pct');
                    const eloValue = isPct ? entry[`${eloField}_Pct`] : entry[eloField];
                    
                    if (eloValue !== null && eloValue !== undefined) {
                        validPoints++;
                        allData.push({
                            skierId: skierId,
                            skierName: menSkierMap[skierId],
                            date: entry.Date,
                            age: entry.Age,
                            exp: entry.Exp,
                            elo: eloValue,
                            x: xAxis === 'Date' ? entry.Date : (xAxis === 'Exp' ? entry.Exp : entry.Age),
                            y: eloValue
                        });
                    }
                });
                console.log('📈 Men\'s skier', menSkierMap[skierId] + ':', validPoints, 'valid data points');
            });
            
            console.log('🎯 Total men\'s data points:', allData.length);
            
            // Group data by skier for chart datasets
            const datasets = [];
            const colors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
            ];
            let colorIndex = 0;
            
            selectedSkierIds.forEach(skierId => {
                const skierDataPoints = allData.filter(d => d.skierId === skierId);
                if (skierDataPoints.length > 0) {
                    // Sort by x-axis value
                    skierDataPoints.sort((a, b) => {
                        if (xAxis === 'Date') {
                            return new Date(a.date) - new Date(b.date);
                        } else if (xAxis === 'Exp') {
                            return a.exp - b.exp;
                        } else {
                            return a.age - b.age;
                        }
                    });
                    
                    // Apply data filtering if requested
                    let filteredPoints = skierDataPoints;
                    if (filtering !== 'none') {
                        const step = parseInt(filtering);
                        filteredPoints = skierDataPoints.filter((point, index) => index % step === 0);
                        console.log('🔽 Filtered', menSkierMap[skierId], 'from', skierDataPoints.length, 'to', filteredPoints.length, 'points');
                    }
                    
                    datasets.push({
                        label: menSkierMap[skierId],
                        data: filteredPoints.map(d => ({
                            x: xAxis === 'Date' ? new Date(d.date) : (xAxis === 'Exp' ? d.exp : d.age),
                            y: d.y
                        })),
                        borderColor: colors[colorIndex % colors.length],
                        backgroundColor: colors[colorIndex % colors.length] + '20',
                        fill: false,
                        tension: smoothing, // Use the selected smoothing value
                        pointRadius: filtering === 'none' ? 1 : 3, // Smaller points when showing all data
                        pointHoverRadius: 4,
                        borderWidth: 2
                    });
                    colorIndex++;
                }
            });
            
            console.log('📊 Created', datasets.length, 'men\'s chart datasets');
            
            // Destroy existing chart if it exists
            if (menChart) {
                console.log('🗑️ Destroying existing men\'s chart...');
                menChart.destroy();
                menChart = null;
            }
            
            // Get canvas and clear any existing Chart.js instances
            const canvas = document.getElementById('myChart');
            const existingChart = Chart.getChart(canvas);
            if (existingChart) {
                console.log('🗑️ Found existing Chart.js instance, destroying...');
                existingChart.destroy();
            }
            
            // Create new chart
            const ctx = canvas.getContext('2d');
            menChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: `Men's ${hillSize} Hill ${yAxis === 'Pct' ? 'Elo Percentage' : 'Elo Rating'} over ${xAxis === 'Exp' ? 'Career Experience' : xAxis}`
                        },
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        x: {
                            ...(xAxis === 'Date' ? {
                                type: 'time',
                                time: {
                                    unit: 'month',
                                    tooltipFormat: 'MMM dd, yyyy',
                                    displayFormats: {
                                        day: 'MMM dd',
                                        month: 'MMM yyyy',
                                        year: 'yyyy'
                                    }
                                }
                            } : {
                                type: 'linear'
                            }),
                            title: {
                                display: true,
                                text: xAxis === 'Exp' ? 'Career Experience' : xAxis
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: yAxis === 'Pct' ? 'Elo Percentage' : 'Elo Rating'
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
            
            console.log('✅ Men\'s chart created successfully!');
            
        } catch (error) {
            console.error('❌ Men\'s chart generation error:', error.message);
            console.error(error);
            alert('Error generating men chart. Please try again.');
        } finally {
            // Hide loading indicator
            document.getElementById('loading-indicator').style.display = 'none';
        }
    }
    
    // Initialize the application when the DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        console.log('🔄 DOM loaded, starting men\'s initialization...');
        initializeMenApp();
    });
    
    // Also try to initialize immediately in case DOM is already loaded
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeMenApp);
    } else {
        // DOM is already loaded
        setTimeout(() => {
            console.log('🔄 Page already loaded, starting men\'s initialization...');
            initializeMenApp();
        }, 100);
    }
</script>